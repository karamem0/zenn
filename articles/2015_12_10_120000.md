---
title: "SPWeb.AllowUnsafeUpdates ã¯ä½¿ã†ã¹ãã§ã¯ãªã„"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2015/12/10 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

`SPSecurity.RunWithElevatedPrivileges` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨ãã«å¿…ãšä¸€ç·’ã«ãŠä¸–è©±ã«ãªã‚‹ `SPWeb.AllowUnsafeUpdates` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã™ãŒã€ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã«ä½•ã‚‚è€ƒãˆãšã«ä½¿ã£ã¦ã„ã‚‹ä¾‹ãŒå¤šã€…ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ä½•ã‚‚è€ƒãˆãšã«ä½¿ã£ã¦ã„ã‚‹ã“ã®ã‚³ãƒ¼ãƒ‰ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚’æ”¹ã‚ã¦æ¤œè¨¼ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

**ç©ºã®ãƒ•ã‚¡ãƒ¼ãƒ  ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³** ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚**è¦–è¦šçš„ Web ãƒ‘ãƒ¼ãƒ„**ã‚’è¿½åŠ ã—ã¦ã€ãƒœã‚¿ãƒ³ã‚’é…ç½®ã—ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ ã‚¤ãƒ™ãƒ³ãƒˆã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```csharp
protected void Button1_Click(object sender, EventArgs e)
{
    var siteId = SPContext.Current.Site.ID;
    var webId = SPContext.Current.Web.ID;
    SPSecurity.RunWithElevatedPrivileges(() =>
    {
        var fileText = "ãƒ†ã‚¹ãƒˆ";
        var fileName = "ãƒ†ã‚¹ãƒˆ.txt";
        var listName = "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ";
        using (var stream = new MemoryStream(Encoding.UTF8.GetBytes(fileText)))
        using (var site = new SPSite(siteId))
        using (var web = site.OpenWeb(webId))
        {
            var list = web.Lists[listName];
            var folder = list.RootFolder;
            web.AllowUnsafeUpdates = true;
            folder.Files.Add(fileName, stream, true);
            web.AllowUnsafeUpdates = false;
        }
    });
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æŠ•ç¨¿æ¨©é™ãŒãªã„å ´åˆã§ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã€`RunWithElevatedPrivileges` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦æ¨©é™ã‚’æ˜‡æ ¼ã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‡¦ç†ã®ç›´å‰ã« `AllowUnsafeUpdates = true` ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿã‚’é˜²ã„ã§ã„ã¾ã™ã€‚

# å•é¡Œç‚¹

`AllowUnsafeUpdates` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¤ã„ã¦ Microsoft Docs ã®èª¬æ˜ã‚’è¦‹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/dotnet/api/microsoft.sharepoint.spweb.allowunsafeupdates?WT.mc_id=M365-MVP-5002941

```
GET è¦æ±‚ã®çµæœã¨ã—ã¦ã€ã‚ã‚‹ã„ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚’è¦æ±‚ã›ãšã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹æ›´æ–°ã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹ã‚’æŒ‡å®šã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ãƒ–ãƒ¼ãƒ«å€¤ã‚’å–å¾—ã¾ãŸã¯è¨­å®šã—ã¾ã™ã€‚
ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ true ã«è¨­å®šã™ã‚‹ã“ã¨ã«ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å ´åˆã«ã‚ˆã£ã¦ã¯ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆ ã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ã®è„†å¼±æ€§ãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```

SharePoint ã§ã¯å¤–éƒ¨ã‹ã‚‰ã®æ”»æ’ƒã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ HTML ãƒšãƒ¼ã‚¸ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€FormDigest ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ä»¥ä¸‹ã® HTML ã‚¿ã‚°ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```html
<input type="hidden" name="__REQUESTDIGEST" id="__REQUESTDIGEST" value="{{digest-value}}" />
```

ã“ã“ã‹ã‚‰é€ã‚‰ã‚Œã‚‹ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå€¤ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ãŠãã‚‰ãã§ã™ãŒã€ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå€¤ã®æ¤œè¨¼ã«ãƒ­ã‚°ã‚¤ãƒ³ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒé–¢ä¿‚ã—ã¦ã„ã‚‹ãŸã‚ã€`RunWithElevatedPrivileges` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰ã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ãã“ã§ã€`AllowUnsafeUpdates` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã£ã¦æ¤œè¨¼ã‚’ã—ãªã„ã‚ˆã†ã«ã™ã‚Œã°ã€ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã§ãã‚‹ã‚ã‘ã§ã™ã€‚ã¨ã„ã†ã“ã¨ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ã¯æ®‹ã£ãŸã¾ã¾ã§ã™ã­ã€‚ã“ã‚Œã¯å•é¡Œã§ã™ã€‚

# å›é¿ç­–

å›é¿ç­–ã¨ã—ã¦ `SPUtility.ValidateFormDigest` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ãŒææ¡ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```csharp
protected void Button1_Click(object sender, EventArgs e)
{
    var siteId = SPContext.Current.Site.ID;
    var webId = SPContext.Current.Web.ID;

    /* ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ  */
    SPUtility.ValidateFormDigest();

    SPSecurity.RunWithElevatedPrivileges(() =>
    {
        var fileText = "ãƒ†ã‚¹ãƒˆ";
        var fileName = "ãƒ†ã‚¹ãƒˆ.txt";
        var listName = "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ";
        using (var stream = new MemoryStream(Encoding.UTF8.GetBytes(fileText)))
        using (var site = new SPSite(siteId))
        using (var web = site.OpenWeb(webId))
        {
            var list = web.Lists[listName];
            var folder = list.RootFolder;
            folder.Files.Add(fileName, stream, true);
        }
    });
}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜‡æ ¼ã™ã‚‹å‰ã«æ¤œè¨¼ã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œã—ã¾ã™ã€‚å®Ÿè¡Œçµæœã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã®ã§ã€ä»¥é™ã®å‡¦ç†ã§ã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã›ã‚“ã€‚è„†å¼±æ€§ã‚‚å›é¿ã§ãã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ã€‚

# ãŠã¾ã‘

`SPSite.OpenWeb` ãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å‰ã§ã‚ã‚Œã° `RunWithElevatedPrivileges` ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ä¸­ã§ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã§ã™ã€‚

```csharp
protected void Button1_Click(object sender, EventArgs e)
{
    var siteId = SPContext.Current.Site.ID;
    var webId = SPContext.Current.Web.ID;
    SPSecurity.RunWithElevatedPrivileges(() =>
    {
        var fileText = "ãƒ†ã‚¹ãƒˆ";
        var fileName = "ãƒ†ã‚¹ãƒˆ.txt";
        var listName = "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ";

        /* ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ  */
        SPUtility.ValidateFormDigest();

        using (var stream = new MemoryStream(Encoding.UTF8.GetBytes(fileText)))
        using (var site = new SPSite(siteId))
        using (var web = site.OpenWeb(webId))
        {
            var list = web.Lists[listName];
            var folder = list.RootFolder;
            folder.Files.Add(fileName, stream, true);
        }
    });
}
```
