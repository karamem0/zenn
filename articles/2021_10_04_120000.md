---
title: "jest.spyOn ã‚’å‘¼ã³å‡ºã™ã¨ TypeError: Cannot redefine property ãŒç™ºç”Ÿã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2021/10/4 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

ãã‚‚ãã‚‚ã¯ Microsoft Graph JavaScript Client Library (`@microsoft/microsoft-graph-client`) ã‚’ 3.0.0 ã«ä¸Šã’ãŸã¨ãã« `BatchResponseContent` ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã¨ã“ã‚ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ãƒ¢ãƒƒã‚¯ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ `BatchResponseContent` ã®ã‚³ãƒ¼ãƒ‰ã«ã¯ä½•ã‚‚å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¡ã‚‡ã£ã¨ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§ issue ã‚’ä¸Šã’ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/microsoftgraph/msgraph-sdk-javascript/issues/514

çµè«–ã‚’ã„ã†ã¨ã€Œ3.0.0 ã‹ã‚‰ TypeScript 4 ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ãã®å½±éŸ¿ã§ã™ã‚ˆã€ã¨ã®ã“ã¨ã€‚ãªã‚‹ã»ã©ã¨ã¯æ€ã„ãªãŒã‚‰ã‚‚ç†è§£ã®ãŸã‚ã«å°‘ã—ç¾è±¡ã‚’è¿½ã£ã¦ã¿ã¾ã—ãŸã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/jest-spyon-with-typescript

ä¸­èº«ã¯åŒã˜ã‚³ãƒ¼ãƒ‰ã§ TypeScript ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã ã‘ãŒé•ã† 2 ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

## src/HelloWorld.ts

```typescript
export class HelloWorld {

  output() {
    console.log('Hello World');
  }

}
```

## src/index.ts

```typescript
export * from './HelloWorld';
```

## tsconfig.json

```json
{
  "compilerOptions": {
    "target": "es6",
    "module": "commonjs",
    "declaration": true,
    "outDir": "dist"
  },
  "include": [
    "src"
  ]
}
```

# ãƒ†ã‚¹ãƒˆ ã‚³ãƒ¼ãƒ‰

ä¸Šè¨˜ã§ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ã¦ `jest.spyOn` ã§ãƒ¢ãƒƒã‚¯ã—ã¾ã™ã€‚

```typescript
import * as typescript2 from 'typescript2';
import * as typescript4 from 'typescript4';

it('jest.spyOn() with typescript 2', () => {
  jest.spyOn(typescript2, 'HelloWorld');
});

it('jest.spyOn() with typescript 4', () => {
  jest.spyOn(typescript4, 'HelloWorld');
});
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®çµæœã«ãªã‚Šã¾ã™ã€‚äº‹è±¡ã¨ã—ã¦ã¯å†ç¾ã§ãã¦ã„ã¾ã™ã­ã€‚TypeSctipt 2 ã§ã¯ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã¾ã™ãŒ TypeScript 4 ã§ã¯ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™ã€‚

```
 FAIL  src/index.test.ts
  âˆš jest.spyOn() with typescript 2 (1 ms)
  Ã— jest.spyOn() with typescript 4 (1 ms)

  â— jest.spyOn() with typescript 4

    TypeError: Cannot redefine property: HelloWorld
        at Function.defineProperty (<anonymous>)

       7 |
       8 | it('jest.spyOn() with typescript 4', () => {
    >  9 |   jest.spyOn(typescript4, 'HelloWorld');
         |        ^
      10 | });
      11 |

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:831:16)
      at Object.<anonymous> (src/index.test.ts:9:8)
```

# ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

## dist/index.js

TypeScript 2.9.2 ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ¼ãƒ‰ãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```typescript
"use strict";
function __export(m) {
    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];
}
Object.defineProperty(exports, "__esModule", { value: true });
__export(require("./HelloWorld"));
```

TypeScript 4.4.3 ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ¼ãƒ‰ãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```typescript
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
__exportStar(require("./HelloWorld"), exports);
```

æ˜ã‚‰ã‹ã«é•ã†ã‚ˆã­ã¨ã„ã†ã®ã¯ã€`__exportStar` ã‹ã‚‰ãã‚Œãã‚Œã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã—ã¦ `__createBinding` ã‚’å‘¼ã‚“ã§ã„ã¦ã€æœ€çµ‚çš„ã« `Object.defineProperty` ãŒå‘¼ã°ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã€‚ã“ã“ã§æ—¢å®šå€¤ã® `configurable: false` ãŒæŒ‡å®šã•ã‚Œã¦èª­ã¿å–ã‚Šå°‚ç”¨ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒã€`jest.spyOn` ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹æ ¹æœ¬åŸå› ã¨æ€ã‚ã‚Œã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ã˜ã‚ƒã‚ã©ã†ã™ã‚Œã°ã„ã„ã®ã‚ˆã£ã¦è©±ã«ãªã‚‹ã®ã§ã™ãŒã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

## ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ index.js ã‹ã‚‰å€‹ã€…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ã™ã‚‹

ãŸã¨ãˆã°å…ˆã®ã‚µãƒ³ãƒ—ãƒ«ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§å›é¿ãŒå¯èƒ½ã§ã™ã€‚`__exportStar` ãŒå‘¼ã°ã‚Œãªã„ã®ã§ `jest.spyOn` ãŒå¯èƒ½ã§ã™ã€‚

```diff
import * as typescript2 from 'typescript2';
- import * as typescript4 from 'typescript4';
+ import * as typescript4 from 'typescript4/dist/HelloWorld';

it('jest.spyOn() with typescript 2', () => {
  jest.spyOn(typescript2, 'HelloWorld');
});

it('jest.spyOn() with typescript 4', () => {
  jest.spyOn(typescript4, 'HelloWorld');
});
```

ãŸã ã—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ webpack ã—ã¦ã‚‹å ´åˆã¯ã“ã®æ–¹æ³•ã¯ã§ããªã„ã§ã™ã€‚

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå´ã§ export * ã‚’ã‚„ã‚ã‚‹

export ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒ‡å®šã—ã¦ã‚ã’ã‚‹ã¨ `__exportStar` ãŒç”Ÿæˆã•ã‚Œãªã„ã®ã§å›é¿ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

```diff
- export * from './HelloWorld';
+ export { HelloWorld } from './HelloWorld';
```

ãŸã ã—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¤‰æ›´ã—ãªã„ã¨ã„ã‘ãªã„ã®ã§é›£ã—ãã¯ã‚ã‚Šã¾ã™ã€‚

## jest.spyOn ã‚’ã‚ãã‚‰ã‚ã‚‹

ãŠã¨ãªã—ã `jest.mock` ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
