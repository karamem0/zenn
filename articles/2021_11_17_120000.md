---
title: "Power Automate ã®æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ API ã‹ã‚‰å–å¾—ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["azuread", "typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2021/11/17 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

Power Automate ã®æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä¾¿åˆ©ãªæ©Ÿèƒ½ã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰ã€Œè‡ªåˆ†ã«ããŸæ‰¿èªã®ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹ã€ã¨ã„ã†ã®ãŒ Power Automate ã®ã‚µã‚¤ãƒˆ (`https://flow.microsoft.com`) ã‹ã‚‰ã—ã‹è¡Œã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ä¾‹ãˆã° SharePoint ãªã©ã‹ã‚‰ã‚‚è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¨åˆ©ä¾¿æ€§ãŒå‘ä¸Šã™ã‚‹ã¨è€ƒãˆã‚‹æ–¹ã‚‚ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚Power Automate ã®æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ Dataverse ã«ä¿å­˜ã•ã‚Œã‚‹ã®ã§ã€Power Appsã€Power Automateã€Dynamics 365 ãªã©ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°ã€REST API ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€Office 365 ã‚„ Microsoft 365 ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ REST API ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ã¨ã¯ã„ãˆã€Office 365 ã‚„ Microsoft 365 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ Power Automate ã®ã‚µã‚¤ãƒˆã‹ã‚‰ã§ã‚ã‚Œã°ã€æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãªã‚“ã¨ã‹ã§ããªã„ã‹ã¨é ‘å¼µã£ã¦ã¿ã¾ã—ãŸã€‚**ã“ã®æ–¹æ³•ã¯ Microsoft Docs ãŒãªã„ãŸã‚ç¾æ™‚ç‚¹ã§ã¯å…¬å¼ã«æ¨å¥¨ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©¦ã™å ´åˆã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚**

# èª¿ã¹ã¦ã¿ã‚‹

ãªã«ã¯ã¨ã‚‚ã‚ã‚Œ F12 é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ Power Automate ã®ã‚µã‚¤ãƒˆã‹ã‚‰å‘¼ã‚“ã§ã„ã‚‹ API ã‚’è¦—ã„ã¦ã¿ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
https://api.flow.microsoft.com/providers/Microsoft.ProcessSimple/environments/{{env-name}}/approvalViews?api-version=2016-11-01&$filter=properties%2FuserRole%20eq%20%27Approver%27
```

`Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã® JWT ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã¿ã¾ã™ã€‚`aud` (Audience) ãŒ `https://service.flow.microsoft.com/` ã«ãªã£ã¦ã„ã¾ã™ã­ã€‚

```json
{
  "aud": "https://service.flow.microsoft.com/",
  "iss": "https://sts.windows.net/a380c832-56bb-4e90-836c-b45ca50c74a1/",
  ...
}
```

Azure AD PowerShell ã§è©²å½“ã™ã‚‹ Azure AD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) ID ãŒ `7df0a125-d3be-4c96-aa54-591f83ff541c` ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚[^1]

```
PS> Get-AzureADServicePrincipal -All $true | ?{ $_.ServicePrincipalNames -contains "https://service.flow.microsoft.com/" }

ObjectId                             AppId                                DisplayName
--------                             -----                                -----------
9faf35a1-cbbf-43a9-a6a2-c65918318858 7df0a125-d3be-4c96-aa54-591f83ff541c Microsoft Flow Service
```

ç¶šã„ã¦ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®ä¸€è¦§ã‚’æŠœãå‡ºã—ã¾ã™ã€‚`Approvals.Read.All` ã¨ã„ã†ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒãªã‚“ã‹ãã‚Œã£ã½ã„æ°—ãŒã—ã¾ã™ã­ã€‚

```
AdminConsentDescription : Allow applications to write plans
AdminConsentDisplayName : Allow applications to write plans
Id                      : 27c61d54-eb42-4315-8793-6e5715a19746
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow applications to write plans
UserConsentDisplayName  : Allow applications to write plans
Value                   : Flows.Write.Plans

AdminConsentDescription : Allow the application read only permission for flow
AdminConsentDisplayName : Allow the application read only permission for flow
Id                      : 0b575251-2c95-46df-bc75-c8c43e6b7116
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application read only permission for flow
UserConsentDisplayName  : Allow the application read only permission for flow
Value                   : Flows.Read.Plans

AdminConsentDescription : Allow the application to read flows
AdminConsentDisplayName : Allow the application to read flows
Id                      : e45c5562-459d-4d1b-8148-83eb1b6dcf83
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application to read flows
UserConsentDisplayName  : Allow the application to read flows
Value                   : Flows.Read.All

AdminConsentDescription : Allow the application to create and edit flows
AdminConsentDisplayName : Allow the application to manage flows
Id                      : 30b2d850-00c3-4802-b7ae-ece9af9de5c6
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application to create and edit flows
UserConsentDisplayName  : Allow the application to manage flows
Value                   : Flows.Manage.All

AdminConsentDescription : Allow the application to read activities
AdminConsentDisplayName : Allow the application to read activities
Id                      : 822a9cde-503a-472d-a530-d1dc9cd0d52b
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application to read activities
UserConsentDisplayName  : Allow the application to read activities
Value                   : Activity.Read.All

AdminConsentDescription : Allow the application to read approvals
AdminConsentDisplayName : Allow the application to read approvals
Id                      : e9cbd5de-0031-493e-8fb1-60712d03cc8b
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application to read approvals
UserConsentDisplayName  : Allow the application to read approvals
Value                   : Approvals.Read.All

AdminConsentDescription : Allow the application to manage approvals
AdminConsentDisplayName : Allow the application to manage approvals
Id                      : d05743e4-fb24-4dff-8a33-0f6c73c964bd
IsEnabled               : True
Type                    : User
UserConsentDescription  : Allow the application to manage approvals
UserConsentDisplayName  : Allow the application to manage approvals
Value                   : Approvals.Manage.All

AdminConsentDescription : Access Microsoft Flow as signed in user
AdminConsentDisplayName : Access Microsoft Flow as signed in user
Id                      : 44d8c55c-9ffc-4546-883e-9041b5bb0b01
IsEnabled               : True
Type                    : Admin
UserConsentDescription  : Allow access to all features in Microsoft Flow
UserConsentDisplayName  : Access Microsoft Flow as signed in user
Value                   : User
```

# è©¦ã—ã¦ã¿ã‚‹

Azure ãƒãƒ¼ã‚¿ãƒ«ã§ Azure AD ã«æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚**API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯** ã‚’è¦‹ã‚‹ã¨ **Flow Service** ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã™ã€‚

![](/images/2021_11_17_120000_001.png)

**Approvals.Read.All** ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/2021_11_17_120000_002.png)

è¿½åŠ ã§ãã¾ã—ãŸã€‚ã“ã‚Œã§ API ãŒå‘¼ã¹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](/images/2021_11_17_120000_003.png)

è©¦ã—ã« Postman ã‚’ä½¿ã£ã¦ API ã‚’å‘¼ã‚“ã§ã¿ã¾ã™ã€‚200 OK ãŒè¿”ã£ã¦ãã¾ã™ã€‚

![](/images/2021_11_17_120000_004.png)

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® JSON ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚ã¡ã‚ƒã‚“ã¨å–ã‚Œã¦ã¾ã™ã­ã€‚

```json
{
    "value": [
        {
            "name": "026092a1-3e66-48a3-bc89-60b80d187f7d",
            "id": "/providers/Microsoft.ProcessSimple/environments/Default-.../approvalViews/026092a1-3e66-48a3-bc89-60b80d187f7d",
            "type": "/providers/Microsoft.ProcessSimple/environments/approvalViews",
            "properties": {
                "type": "Basic",
                "isActive": false,
                "userRoles": [
                    "Owner",
                    "Approver"
                ],
                "owner": {
                    "id": "8f7f93f0-...",
                    "type": "User",
                    "tenantId": "a380c832-..."
                },
                "title": "æ‰¿èªãƒªã‚¯ã‚¨ã‚¹ãƒˆ from Takashi Shinohara",
                "result": "Approve",
                "allowCancel": true,
                "creationDate": "2021-11-11T23:20:52Z",
                "dueDate": "9999-12-31T23:59:59Z",
                "expirationDate": "9999-12-31T23:59:59Z",
                "completionDate": "2021-11-11T23:37:31Z",
                "approvers": [
                    "8f7f93f0-..."
                ],
                "principals": [
                    {
                        "id": "8f7f93f0-...",
                        "displayName": "Takashi Shinohara",
                        "email": "takashi.shinohara@example.onmicrosoft.com",
                        "type": "User",
                        "tenantId": "a380c832-...",
                        "userPrincipalName": "takashi.shinohara@example.onmicrosoft.com"
                    }
                ],
                "priority": "Medium",
                "requestType": "Basic"
            }
        }
    ]
}
```

# ãŠã‚ã‚Šã«

`Approvals.Manage.All` ã‚’ä½¿ãˆã° API ã‹ã‚‰ã®æ‰¿èªã‚„å´ä¸‹ã‚‚ã§ããã†ã§ã™ã€‚ç¹°ã‚Šè¿”ã—ã¾ã™ãŒ Microsoft Docs ã§ã¯å…¬é–‹ã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ã®ã‚ˆã†ãªã®ã§è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ãŸã„ã§ã™ãŒã€ã¡ã‚ƒã‚“ã¨å…¬é–‹ã•ã‚ŒãŸã‚‰ã¨ã¦ã‚‚ä¾¿åˆ©ãã†ã§ã™ã­ã€‚

[^1]: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID ã¯ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚Šã¾ã™ã€‚
