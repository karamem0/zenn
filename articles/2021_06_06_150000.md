---
title: "Microsoft Bookings API ã¨ Microsoft Bot Framework v4 ã‚’ä½¿ã£ã¦äºˆç´„ãƒœãƒƒãƒˆã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ’»"
type: "tech"
topics: ["azure", "csharp", "microsoftgraph"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2021/6/6 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

Microsoft Graph ã«ã¯ã¾ã ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ãŒ Microsoft Bookings API ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€Microsoft Bookings ã§æä¾›ã•ã‚Œã¦ã„ã‚‹å…¬é–‹ãƒšãƒ¼ã‚¸ä»¥å¤–ã§ã‚‚äºˆç´„ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ã®ãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯ã›ã£ã‹ããªã®ã§ Microsoft Bot Framework ã¨ Azure Bot Service ã‚’ä½¿ã£ã¦ LINE ã‹ã‚‰äºˆç´„ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/bookingservicebot

# å®Ÿè¡Œæ–¹æ³•

## Microsoft Bookings API ã«ã¤ã„ã¦

Microsoft Bookings API ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒä½¿ãˆãšã€å§”ä»»ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã—ã‹ä½¿ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚ŠãŸã„ã®ã§ã€ã“ã®ä»•æ§˜ã§ã¯éå¸¸ã«å›°ã‚‹ã®ã§ã™ãŒã€ä»•æ–¹ãŒãªã„ã®ã§ãƒ“ã‚¸ãƒã‚¹ã«å¯¾ã—ã¦ç®¡ç†è€…ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ OAuth ã® Resource Owner Password Credentials Grant ã«ã‚ˆã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚Œã¯æ¨å¥¨ã•ã‚Œã¦ã„ãªã„æ–¹æ³•ãªã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth-ropc?WT.mc_id=M365-MVP-5002941

ã¨ã¯ã„ãˆã»ã‹ã«æ–¹æ³•ãŒãªã„ã®ã§ä»•æ–¹ãªã„ã¨ã„ã†ã“ã¨ã«ã—ã¾ã™ã€‚ã“ã“ã¯ GA ã«ãªã£ãŸã‚‰æ”¹å–„ã—ã¦ã»ã—ã„ã§ã™ã­ã€‚

Microsoft Graph ã«ã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã® SDK ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ãŒã€Resource Owner Password Credentials Grant ã«å¯¾å¿œã™ã‚‹ã„ã„æ„Ÿã˜ã® AuthenticationProvider ãŒæä¾›ã•ã‚Œã¦ã„ãªã„ã®ã§ã€è‡ªä½œã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚ãƒœãƒƒãƒˆã¯é•·æ™‚é–“å‹•ãã£ã±ãªã—ã«ãªã‚‹ã®ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’è€ƒãˆãªã„ã¨ç—›ã„ç›®ã«åˆã„ã¾ã™ã€‚

```csharp
private class UsernamePasswordProvider : IAuthenticationProvider
{

    private readonly IPublicClientApplication application;

    private readonly NetworkCredential credentials;

    private AuthenticationResult authenticationResult;

    public UsernamePasswordProvider(IPublicClientApplication application, NetworkCredential credentials)
    {
        this.application = application;
        this.credentials = credentials;
    }

    public async Task AuthenticateRequestAsync(HttpRequestMessage request)
    {
        if (this.authenticationResult == null ||
            this.authenticationResult.ExpiresOn <= DateTime.UtcNow)
        {
            this.authenticationResult =
                await application
                    .AcquireTokenByUsernamePassword(
                        null,
                        this.credentials.UserName,
                        this.credentials.SecurePassword)
                    .ExecuteAsync();
        }
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", this.authenticationResult.AccessToken);
    }

}
```

## Microsoft Bot Framework ã«ã¤ã„ã¦

Microsoft Bot Framework v4 ã«ã¤ã„ã¦ã¯æ—¥æœ¬ãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆã®ä¸­æ‘æ†²ä¸€éƒã•ã‚“ã®è¨˜äº‹ãŒã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚ã¶ã£ã¡ã‚ƒã‘ã“ã‚Œã•ãˆè¦‹ã‚Œã°ã ã„ãŸã„ã‚ã‹ã‚Šã¾ã™ã€‚

https://qiita.com/kenakamu/items/6dc043cfc1f199032883

ä»Šå›ã®ã‚ˆã†ã«ãƒ•ãƒ­ãƒ¼ã«ã—ãŸãŒã£ã¦ãƒœãƒƒãƒˆã‚’å‹•ã‹ã—ãŸã„ã¨ãã¯ Microsoft Bot Framework v4 ã®ä½œæ³•ã§ã¯ `WaterfallDialog` ã‚’ä½¿ã†ã¿ãŸã„ã§ã™ã€‚`WaterfallStep` ã«ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ãŠãã¨ãã®é †ç•ªã§ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚å„ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€Œç›´å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰é€ã‚‰ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã€ã“ã¨ã¨ã€Œæ¬¡ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã€ã“ã¨ã‚’è¡Œã„ã¾ã™ã€‚æœ¬å½“ã¯ 1 ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã« 2 ä»¥ä¸Šã®è²¬å‹™ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã¯æœ›ã¾ã—ããªã„ã®ã§ã¡ã‚ƒã‚“ã¨ä½œã‚‹ã¨ãã¯ã•ã‚‰ã«åˆ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ†å‰²ã—ãŸã»ã†ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚ã„ã£ãŸã‚“ã‚µãƒ³ãƒ—ãƒ«ã¨ã„ã†ã“ã¨ã§ãã®ã¾ã¾ã«ã—ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«ã‚„ã£ã¦ã„ã‚‹æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Microsoft Bookings ã®ãƒ“ã‚¸ãƒã‚¹ã®ä¸€è¦§ã‚’é¸æŠã•ã›ã‚‹
- é¸æŠã•ã‚ŒãŸãƒ“ã‚¸ãƒã‚¹ã§æä¾›ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ä¸€è¦§ã‚’é¸æŠã•ã›ã‚‹
- äºˆç´„å¯¾è±¡ã®æ—¥ä»˜ã‚’é¸æŠã•ã›ã‚‹
- äºˆç´„å¯¾è±¡ã®æ™‚é–“ã‚’é¸æŠã•ã›ã‚‹
- åå‰ã‚’å…¥åŠ›ã•ã›ã‚‹
- ãƒ¡ãƒ¼ãƒ« ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã•ã›ã‚‹
- äºˆç´„å†…å®¹ã‚’ç¢ºèªã•ã›ã‚‹

æ—¥æ™‚ã«é–¢ã—ã¦ã¯ã€Microsoft Bookings ã«ã¯å–¶æ¥­æ™‚é–“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®æ™‚é–“ã®è¨­å®šã‚‚ã‚ã‚‹ã®ã§ã€å†…éƒ¨çš„ã«ã¯ç´°ã‹ã„ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¾ã™ãŒã€ã“ã®ã‚ãŸã‚Šã¯ã‚‚ã†ã¡ã‚‡ã£ã¨ API ã§å‡¦ç†ã—ã¦ãã‚Œã‚‹ã¨ã‚ã‚ŠãŒãŸã„ãªã¨æ€ã„ã¾ã—ãŸã€‚

æœ€çµ‚çš„ã«åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦äºˆç´„ã‚’ä½œæˆã—ã¾ã™ã€‚Microsoft Docs ã‚’è¦‹ã‚‹ã¨ç™»éŒ²å†…å®¹ã¨ã—ã¦ãŸãã•ã‚“ã®é …ç›®ãŒã‚ã‚Šã¾ã™ãŒæœ€ä½é™ã®å†…å®¹ã§ã‚‚ç™»éŒ²ã§ãã¾ã™ã€‚æ³¨æ„ã—ãŸã„ã®ã¯ä»¥ä¸‹ã® 2 ç‚¹ã§ã™ã€‚

- `CustomerId` ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æŒ‡å®šã—ãªã„ã¨åŒã˜ãƒ¡ãƒ¼ãƒ« ã‚¢ãƒ‰ãƒ¬ã‚¹ã§é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒè¤‡æ•°ä½œã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚äº‹å‰ã«ãƒ¡ãƒ¼ãƒ« ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ã—ã¦é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `StaffMemberIds` ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æŒ‡å®šã—ãªã„ã¨ Microsoft Teams ä¼šè­°ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚ä»Šå›ã¯ã‚¹ã‚¿ãƒƒãƒ•ã‚’æŒ‡å®šã—ãªã„ã®ã§ã„ã£ãŸã‚“å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã® ID ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```csharp
private async Task<DialogTurnResult> SubmitBookingAsync(WaterfallStepContext stepContext, CancellationToken cancellationToken)
{
    if ((bool)stepContext.Result)
    {
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹
        var bookingProfile = await this.bookingProfileAccessor.GetAsync(stepContext.Context, () => new BookingProfile(), cancellationToken);
        try
        {
            // äºˆç´„ã‚’ä½œæˆã™ã‚‹
            await this.graphServiceClient
                .BookingBusinesses[bookingProfile.BookingBusinessId]
                .Appointments
                .Request()
                .AddAsync(new Graph.BookingAppointment()
                {
                    CustomerId = bookingProfile.BookingCustomerId,
                    CustomerName = bookingProfile.BookingCustomerName,
                    CustomerEmailAddress = bookingProfile.BookingCustomerEmail,
                    End = new Graph.DateTimeTimeZone()
                    {
                        DateTime = bookingProfile.BookingEndTime.ToUniversalTime().ToString("s"),
                        TimeZone = "UTC",
                    },
                    ServiceId = bookingProfile.BookingServiceId,
                    ServiceName = bookingProfile.BookingServiceName,
                    Start = new Graph.DateTimeTimeZone()
                    {
                        DateTime = bookingProfile.BookingStartTime.ToUniversalTime().ToString("s"),
                        TimeZone = "UTC",
                    },
                    StaffMemberIds = new[] { bookingProfile.BookingStaffMemberId }
                });
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
            await stepContext.Context.SendActivityAsync(MessageFactory.Text(StringResources.CompleteBookingMessage));
        }
        catch (Exception ex)
        {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
            await stepContext.Context.SendActivityAsync(MessageFactory.Text(ex.Message));
        }
    }
    else
    {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
        await stepContext.Context.SendActivityAsync(MessageFactory.Text(StringResources.CancelBookingMessage));
    }
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’çµ‚äº†ã™ã‚‹
    return await stepContext.EndDialogAsync(null, cancellationToken);
}
```

## LINE ã‹ã‚‰ã®å®Ÿè¡Œ

ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ Azure App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚æ™®é€šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°ã„ã„ã§ã™ãŒã€æ™‚åˆ»ã‚’æ‰±ã†ãŸã‚ã€`WEBSITE_TIME_ZONE` ã‚’æŒ‡å®šã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

![](/images/2021_06_06_150000_001.png)

Azure Bot Service ã‚’ä½œæˆã—ã¦ Azure App Service ã«é–¢é€£ä»˜ã‘ã¾ã™ã€‚[^1] LINE Developer ã«ç™»éŒ²ã—ã¦è¨­å®šã™ã‚Œã°å®Œæˆã§ã™ã€‚

https://docs.microsoft.com/ja-jp/azure/bot-service/bot-service-channel-connect-line?WT.mc_id=M365-MVP-5002941

å®Ÿéš›ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

![](/images/2021_06_06_150000_002.png =240x)

![](/images/2021_06_06_150000_003.png =240x)

äºˆç´„ãŒå®Œäº†ã™ã‚‹ã¨ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

![](/images/2021_06_06_150000_004.png)

Microsoft Bookings ã‹ã‚‰ã‚‚äºˆå®šãŒç¢ºèªã§ãã¾ã™ã€‚

![](/images/2021_06_06_150000_005.png)

# ãŠã‚ã‚Šã«

Microsoft Bookings API ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãŸã‚ã€ã¾ã ã¾ã ã§ããªã„ã“ã¨ãŒå¤šãã€æœ¬ç•ªé‹ç”¨ã«ã¯å‘ã‹ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãŸã ã— API ã® GA ãŒäºˆå‘Šã•ã‚Œã¦ã„ã‚‹ãŸã‚ä»Šå¾Œã«ã¤ã„ã¦ã¯æœŸå¾…ãŒã§ãã¾ã™ã€‚COVID-19 ã®å½±éŸ¿ã§ã‚ªãƒ³ã‚µã‚¤ãƒˆã‚„ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã‹ã‹ã‚ã‚‰ãšäºˆç´„ã®éœ€è¦ã¯é«˜ã¾ã£ã¦ã„ã¾ã™ã®ã§æ´»ç”¨ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://techcommunity.microsoft.com/t5/microsoft-bookings-blog/a-new-more-powerful-and-customizable-microsoft-bookings-is-here/ba-p/2401907?WT.mc_id=M365-MVP-5002941

[^1]: ä½™è«‡ã§ã™ãŒ Azure Bot Service ã§ä½¿ã† Microsoft App Id ã¨ Microsoft App Password ã£ã¦è‡ªåˆ†ã®ãƒ†ãƒŠãƒ³ãƒˆã§ä½œæˆã—ãŸ Azure AD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã˜ã‚ƒé§„ç›®ãªã‚“ã§ã™ã­ã€‚ãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
