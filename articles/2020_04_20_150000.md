---
title: "SharePoint Framework ã§ Common Data Service ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["sharepoint", "typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2020/4/20 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

SharePoint Framework ã§ã¯ `AadHttpClient` ã‚’ä½¿ã†ã“ã¨ã§ Azure AD ã§ä¿è­·ã•ã‚ŒãŸ API ã«å¯¾ã—ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ OAuth ã®è¨­å®šã‚’è¡Œã†ã“ã¨ãªãç°¡å˜ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã¯ Common Data Service (Dynamics 365) ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¯ãšãªã®ã§è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# äº‹å‰æº–å‚™

é€šå¸¸ã€SharePoint Framework ã«å¯¾ã—ã¦ Web API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ä¸ãˆã‚‹ãŸã‚ã«ã¯ã€`package-solution.json` ã« `webApiPermissionRequests` ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜è¿°ã«ã—ãŸãŒã£ã¦ã€SharePoint ç®¡ç†ã‚»ãƒ³ã‚¿ãƒ¼ã§ API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ‰¿èªã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã™ãŒã€Common Data Service ã®å ´åˆã€æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã‚‚å®Ÿã¯ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

```json
{
  "$schema": "https://developer.microsoft.com/json-schemas/spfx-build/package-solution.schema.json",
  "solution": {
    "name": "MyApplication",
    "id": "ad9139c7-12db-470b-937d-54967f418959",
    "version": "1.0.0.0",
    "includeClientSideAssets": true,
    "isDomainIsolated": false,
    "webApiPermissionRequests": [
      {
        "resource": "Common Data Service",
        "scope": "user_impersonation"
      }
    ]
  },
  "paths": {
    "zippedPackage": "solution/sharepoint-framework-read-dynamics.sppkg"
  }
}
```

ã“ã‚Œã¯ã€Common Data Service ã¨ã„ã†åå‰ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒè¤‡æ•°ã‚ã‚Šã€è¡¨ç¤ºåã§ç´ã¥ã‘ã—ã‚ˆã†ã¨ã™ã‚‹ã¨åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«çµã³ã¤ã„ã¦ã—ã¾ã†ã“ã¨ãŒåŸå› ã®ã‚ˆã†ã§ã™ã€‚SharePoint Framework ã®å•é¡Œãªã®ã§ã™ãŒã€å…¬å¼ã§ã‚‚è¡¨ç¤ºåã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«æ³¨é‡ˆãŒã‚ã‚‹ãŸã‚ã€ãªã‚“ã‚‰ã‹ã®åŸå› ãŒã‚ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

> resource ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã«ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¦æ±‚ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® displayName ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ãƒªã‚½ãƒ¼ã‚¹ã®æŒ‡å®šã« objectId ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®è¦æ±‚ã‚’æ‰¿èªã—ã‚ˆã†ã¨ã—ãŸã¨ãã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/sharepoint/dev/spfx/use-aadhttpclient?WT.mc_id=M365-MVP-5002941

ã¨ã„ã†ã“ã¨ã§ã€Common Data Service ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ä¸ãˆã‚‹ãŸã‚ã«ã€Azure ãƒãƒ¼ã‚¿ãƒ«ã§æ“ä½œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚SharePoint Framework ã¯ **SharePoint Online Client Extensibility Web Application Principal** ã¨ã„ã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ä¸ãˆã¦ã„ã¾ã™ã€‚ç›´æ¥ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã§ SharePoint ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã§ã®æ‰¿èªã¨åŒã˜ã“ã¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

![](/images/2020_04_20_150000_001.png)

SharePoint ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰è¦‹ãŸã¨ãã‚‚æ‰¿èªã•ã‚ŒãŸè¦æ±‚ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã— SharePoint Framework ã®ã‚¢ãƒ—ãƒªåãªã©ã®ãƒ¡ã‚¿æƒ…å ±ã¯è¡¨ç¤ºã•ã‚Œãªã„ã¿ãŸã„ã§ã™ã­ã€‚

![](/images/2020_04_20_150000_002.png)

ã¨ã‚‚ã‚ã‚Œã€ã“ã‚Œã§ Common Data Service ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/master/sharepoint-framework-read-dynamics

# ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°

## src/webparts/my-application/MyApplicationWebPart.ts

ãŠç´„æŸã¨ã—ã¦ `context` ã‚’æ¸¡ã—ã¦ãŠãã®ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚endpoint ã¯ Dynamics 365 ã® URL ã‚’è¡¨ã—ã¾ã™ã€‚

```typescript
export default class MyApplicationWebPart extends BaseClientSideWebPart<IMyApplicationWebPartProps> {

  public render(): void {
    const element: React.ReactElement<IMyApplicationProps> = React.createElement(
      MyApplication,
      {
        context: this.context,
        endpoint: this.properties.endpoint
      }
    );

    ReactDom.render(element, this.domElement);
  }

}
```

## src/webparts/my-application/components/MyApplication.tsx

`componentDidMount` ãƒ¡ã‚½ãƒƒãƒ‰ã§ `AadHttpClient` ã‚’ä½¿ã£ã¦ Common Data Service Web API ã¸ã®è¦æ±‚ã‚’è¡Œã„ã¾ã™ã€‚ä»Šå›ã¯æ¨™æº–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ  ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«å–å¾—ãŒå¯èƒ½ã§ã™ã€‚

```typescript
export default class MyApplication extends React.Component<IMyApplicationProps, IMyApplicationState> {

  public componentDidMount(): void {
    if (this.props.endpoint == null) {
      return;
    }
    this.props.context.aadHttpClientFactory
      .getClient(this.props.endpoint)
      .then((client: AadHttpClient) => {
        client
          .get(this.props.endpoint + "/api/data/v9.0/accounts", AadHttpClient.configurations.v1)
          .then((response: HttpClientResponse) => response.json())
          .then((response: any) => {
            this.setState({ accounts: response.value as Array<IAccount> });
          });
      });
  }

}
```

# å®Ÿè¡Œçµæœ

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚ãªãŠã€Common Data Service ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ (Power Apps ã‚„ Dynamics 365 Sales ãªã©) ãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯è¡¨ç¤ºã§ãã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚

![](/images/2020_04_20_150000_003.png)

# ãŠã‚ã‚Šã«

ç›´æ¥ Azure AD ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ“ä½œã™ã‚‹ã¨ã„ã†ã®ãŒã„ã•ã•ã‹ãƒˆãƒªãƒƒã‚­ãƒ¼ã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€ä½¿ãˆã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãªã®ã§ãœã²ãŠè©¦ã—ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
