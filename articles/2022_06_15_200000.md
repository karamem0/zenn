---
title: "Avanade Beef ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’ç†è§£ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["dotnet", "beef"]
published: true
---

# ã¯ã˜ã‚ã«

Avanade Beef ã¯ ASP.NET Core ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹ Web API ã®è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://github.com/Avanade/Beef

æ¦‚è¦ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚‚ã”è¦§ãã ã•ã„ã€‚

@[speakerdeck](084022d090bb4df38512435904e85aa9)

Avanade Beef ã‚’ç†è§£ã™ã‚‹ä¸Šã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹ã“ã¨ã¯éå¸¸ã«é‡è¦ã§ã™ã€‚åŸºæœ¬çš„ã«ã¯ä»¥ä¸‹ã«ç¤ºã™å›³ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€è‹±èªãªã®ã§ã‚ã‹ã‚Šã«ãã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ã€ã–ã£ãã‚Šã¨è§£èª¬ã‚’ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

![](https://raw.githubusercontent.com/Avanade/Beef/59dd277bd1ddeb822f76929cc07135b65e89eb72/docs/images/Layers.png)

# ã‚µãƒ¼ãƒ“ã‚¹ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤ (XxxController)

ã‚µãƒ¼ãƒ“ã‚¹ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ (å¤–è¦³) ã¨ãªã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚`Api` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« `XxxController` ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ ASP.NET Core  MVC ã§ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨åŒç­‰ã§ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯å¤–éƒ¨ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å—ã‘å–ã‚Šã€ä¸‹å±¤ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ ãƒ­ã‚¸ãƒƒã‚¯ (XxxManager) ã‚’å‘¼ã³å‡ºã—ã€HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ã‚³ãƒ¼ãƒ‰ãŠã‚ˆã³çµæœã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (JSON) ã‚’è¿”ã—ã¾ã™ã€‚ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (ä¾‹ãˆã° JSON ã§ã¯ãªã XML ã‚’è¿”ã™ãªã©) ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã§ã™ (è¦‹ã‚„ã™ã•ã®ãŸã‚ã«æ”¹å¤‰ã—ã¦ã„ã¾ã™)ã€‚

```csharp
namespace Foo.Bar.Api.Controllers
{
    [Route("persons")]
    public partial class PersonController : ControllerBase
    {
        private readonly IPersonManager _manager;

        public PersonController(IPersonManager manager)
            { _manager = Check.NotNull(manager, nameof(manager)); PersonControllerCtor(); }

        [HttpGet("{id}")]
        [ProducesResponseType(typeof(Person), (int)HttpStatusCode.OK)]
        [ProducesResponseType((int)HttpStatusCode.NotFound)]
        public IActionResult Get(Guid id) =>
            new WebApiGet<Person?>(this, () => _manager.GetAsync(id),
                operationType: OperationType.Read, statusCode: HttpStatusCode.OK, alternateStatusCode: HttpStatusCode.NotFound);
    }
}
```

# ãƒ‰ãƒ¡ã‚¤ãƒ³ ãƒ­ã‚¸ãƒƒã‚¯å±¤ (XxxManager)

ãƒ‰ãƒ¡ã‚¤ãƒ³ ãƒ­ã‚¸ãƒƒã‚¯å±¤ã¯ãƒ“ã‚¸ãƒã‚¹ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚`Business` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« `XxxManager` ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯å¿…è¦ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (æ–‡å­—åˆ—ã‚„æ—¥æ™‚ã® Trim ãªã©) ã‚’è¡Œã„ã€ä¸‹å±¤ã®ã‚µãƒ¼ãƒ“ã‚¹ ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (XxxDataSvc) ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆæ™‚ã« ID ã¨ãªã‚‹ GUID ã®ç”Ÿæˆã‚’è¡Œã£ãŸã‚Šã‚‚ã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã§ã™ (è¦‹ã‚„ã™ã•ã®ãŸã‚ã«æ”¹å¤‰ã—ã¦ã„ã¾ã™)ã€‚

```csharp
namespace Foo.Bar.Business
{
    public partial class PersonManager : IPersonManager
    {
        private readonly IPersonDataSvc _dataService;

        public PersonManager(IPersonDataSvc dataService, IGuidIdentifierGenerator guidIdentifierGenerator)
            { _dataService = Check.NotNull(dataService, nameof(dataService)); _guidIdentifierGenerator = Check.NotNull(guidIdentifierGenerator, nameof(guidIdentifierGenerator)); PersonManagerCtor(); }

        public Task<Person?> GetAsync(Guid id) => ManagerInvoker.Current.InvokeAsync(this, async () =>
        {
            Cleaner.CleanUp(id);
            await id.Validate(nameof(id)).Mandatory().RunAsync(throwOnError: true).ConfigureAwait(false);
            return Cleaner.Clean(await _dataService.GetAsync(id).ConfigureAwait(false));
        }, BusinessInvokerArgs.Read);
    }
}
```

# ã‚µãƒ¼ãƒ“ã‚¹ ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (XxxDataSvc)

ã‚µãƒ¼ãƒ“ã‚¹ ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¯ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚`Business` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« `XxxDataSvc` ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯ãƒ‡ãƒ¼ã‚¿ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¤œç´¢ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã®å€¤ã‚’ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã°ä¸‹å±¤ã®ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ (XxxData) ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé–“ã¯ `webapisettings.json` ã«ã‚ˆã£ã¦è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã§ã™ (è¦‹ã‚„ã™ã•ã®ãŸã‚ã«æ”¹å¤‰ã—ã¦ã„ã¾ã™)ã€‚

```csharp
namespace Foo.Bar.Business.DataSvc
{
    public partial class PersonDataSvc : IPersonDataSvc
    {
        private readonly IPersonData _data;
        private readonly IRequestCache _cache;

        public PersonDataSvc(IPersonData data, IRequestCache cache)
            { _data = Check.NotNull(data, nameof(data)); _cache = Check.NotNull(cache, nameof(cache)); PersonDataSvcCtor(); }

        public Task<Person?> GetAsync(Guid id) => DataSvcInvoker.Current.InvokeAsync(this, async () =>
        {
            var __key = new UniqueKey(id);
            if (_cache.TryGetValue(__key, out Person? __val))
                return __val;

            var __result = await _data.GetAsync(id).ConfigureAwait(false);
            return _cache.SetAndReturnValue(__key, __result);
        });
    }
}
```

# ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹å±¤ (XxxData)

ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹å±¤ã¯ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ (ã‚¹ãƒˆã‚¢ãƒ‰ ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®å‘¼ã³å‡ºã—ãªã©) ã‚’æä¾›ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚`Business` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« `XxxData` ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯ Cosmos DBã€SQL Databaseã€OData ãªã©ã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã‚¯ã‚¨ãƒªã®ä½œæˆã‚‚è¡Œã„ã¾ã™ã€‚ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (å‰è¿°ã—ãŸä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãªã©) ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã§ã™ (è¦‹ã‚„ã™ã•ã®ãŸã‚ã«æ”¹å¤‰ã—ã¦ã„ã¾ã™)ã€‚

```csharp
namespace Foo.Bar.Business.Data
{
    public partial class PersonData : IPersonData
    {
        private readonly IEfDb _ef;
        private readonly AutoMapper.IMapper _mapper;
        private readonly IEventPublisher _evtPub;

        public PersonData(IEfDb ef, AutoMapper.IMapper mapper, IEventPublisher evtPub)
            { _ef = Check.NotNull(ef, nameof(ef)); _mapper = Check.NotNull(mapper, nameof(mapper)); _evtPub = Check.NotNull(evtPub, nameof(evtPub)); PersonDataCtor(); }

        public Task<Person?> GetAsync(Guid id) => DataInvoker.Current.InvokeAsync(this, async () =>
        {
            var __dataArgs = EfDbArgs.Create(_mapper);
            return await _ef.GetAsync<Person, EfModel.Person>(__dataArgs, id).ConfigureAwait(false);
        });
    }
}
```

# ã‚µãƒ¼ãƒ“ã‚¹ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå±¤ (XxxAgent)

ã‚µãƒ¼ãƒ“ã‚¹ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå±¤ã¯ã‚µãƒ¼ãƒ“ã‚¹ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤ã®å‘¼ã³å‡ºã—ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’æä¾›ã—ã¾ã™ã€‚ä¸»ãªç”¨é€”ã¨ã—ã¦ã¯ãƒ†ã‚¹ãƒˆ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚µãƒ¼ãƒ“ã‚¹ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (Controller) ã®å‘¼ã³å‡ºã—ã‚’ç°¡æ½”ã«ã—ã¾ã™ã€‚

# ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (DTO)

ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã¿ã¾ã›ã‚“ãŒ ICloneableã€ICopyFromã€IEquatable ãªã©ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

Avanade Beef ã®ç‰¹é•·ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ (ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ« ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ã“ã¨ã§) æ¯”è¼ƒçš„è‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ç‚¹ã«ã‚ã‚Šã¾ã™ãŒã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ§‹é€ ã‚’çŸ¥ã‚‰ãªã„ã¨ãªã‹ãªã‹å›°ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®ã‚ãŸã‚Šã‚’ç†è§£ã—ã¦ãŠãã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒæ¥½ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
