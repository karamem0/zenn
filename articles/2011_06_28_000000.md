---
title: "System.DirectoryServices åå‰ç©ºé–“ã‚’ä½¿ã£ã¦ LDAP æ¤œç´¢ã‚’ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2011/6/28 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

`System.DirectoryServices.dll` ã‚’å‚ç…§è¨­å®šã™ã‚‹ã¨ LDAP (Lightweight Directory Access Protocol) ã«ã‚ˆã‚‹ Active Directory æ¤œç´¢ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚„ã£ã¦ã¿ãŸã‚‰ãã‚Œã»ã©é›£ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚’ã—ã¦ã¿ã‚‹

`example.com` ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚ªãƒ³å (`userPrincipalName`) ã§æ¤œç´¢ã—ã¦ã¿ã¾ã™ã€‚`DirectoryEntry` ã‚¯ãƒ©ã‚¹ã¯ Active Directory ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã¾ã™ã€‚`DirectorySearcher` ã‚¯ãƒ©ã‚¹ã§ã‚¯ã‚¨ãƒªå¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```csharp
public static class Program
{

    private static void Main(string[] args)
    {
        // æ¤œç´¢ã™ã‚‹ãƒ«ãƒ¼ãƒˆéšå±¤ã‚’æŒ‡å®šã™ã‚‹
        using (var entry = new DirectoryEntry("LDAP://example.com/CN=Users,DC=example,DC=com"))
        using (var searcher = new DirectorySearcher(entry))
        {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚ªãƒ³åãŒ hoge@example.com ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹
            searcher.Filter = "(userPrincipalName=hoge@example.com)";
            // 1 ä»¶ã ã‘æŠ½å‡ºã™ã‚‹ã¨ãã¯ FindOne ãƒ¡ã‚½ãƒƒãƒ‰ã§
            // çµæœãŒè¤‡æ•°ä»¶æˆ»ã£ã¦ãã‚‹ã¨ãã¯ FindAll ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†
            var result = searcher.FindOne();
            foreach (var value in result.GetDirectoryEntry().Properties
                .Cast<PropertyValueCollection>()
                .OrderBy(x => x.PropertyName))
            {
                // å±æ€§ã¨å€¤ã‚’ã™ã¹ã¦è¡¨ç¤ºã™ã‚‹
                Console.WriteLine("{0}={1}", 
                    value.PropertyName, 
                    string.Join(";", value.Cast<object>().Select(x => x.ToString())));
            }
        }
        Console.ReadKey();
    }

}
```

LDAP ã‚¯ã‚¨ãƒªã¯æ›¸ãæ–¹ãŒç‰¹æ®Šã§ã€and æ¡ä»¶ã¯ `(&(A=b)(B=b))` ã®ã‚ˆã†ã«æ›¸ãã€or æ¡ä»¶ã¯ `(|(A=a)(B=b))` ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚æ…£ã‚Œã¦ã—ã¾ãˆã°ãã‚Œã»ã©ã¯é›£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚‚ä½¿ãˆã¾ã™ã®ã§ã€ã‚ã‚‹ç¨‹åº¦è‡ªç”±ã®åˆ©ã„ãŸæ¤œç´¢ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

`FindOne` ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã¯ `SearchResult` ã‚¯ãƒ©ã‚¹ã§ã™ã€‚`GetDirectoryEntry` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã° `DirectoryEntry` ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå–å¾—ã§ãã‚‹ã®ã§ã€å±æ€§ã‚’å–å¾—ã—ãŸã‚Šã€ã•ã‚‰ã«åˆ¥ã®æ¤œç´¢ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¡ãªã¿ã« Active Directory ã®å±æ€§ã¯å˜ä¸€ã®å€¤ã‚’è¿”ã™ã‚‚ã®ã¨è¤‡æ•°ã®å€¤ã‚’è¿”ã™ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€`PropertyValueCollection` ã‚¯ãƒ©ã‚¹ã«ã¯ `Value` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ `Items` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã® 2 ç¨®é¡ã®æ–¹æ³•ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ LINQ ã§ã¶ã‚“å›ã—ã¦è¤‡æ•°ã®å€¤ã‚’ `string.Join` ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¤œç´¢ã‚’ã—ã¦ã¿ã‚‹

ã¡ã‚‡ã£ã¨ã ã‘å¿œç”¨ç·¨ã€‚æ¤œç´¢ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¤œç´¢ã—ã¾ã™ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ã® `member` å±æ€§ã«ã¯è­˜åˆ¥åãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `distinguishedName` å±æ€§ã®å€¤ã‚’æ¸¡ã—ã¦ã‚ã’ã¾ã™ã€‚ä»Šåº¦ã¯çµæœãŒè¤‡æ•°ã‚ã‚‹ã®ã§ `FindAll` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚LINQ ã«ã¯å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ `Cast` ã—ãŸã‚Š `Select` ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã®ã¯å¾¡æ„›å¬Œã¨ã„ã†ã“ã¨ã§ã€‚

```csharp
public static class Program
{

    private static void Main(string[] args)
    {
        using (var entry = new DirectoryEntry("LDAP://example.com/CN=Users,DC=domain,DC=local"))
        using (var searcher = new DirectorySearcher(entry))
        {
            searcher.Filter = "(userPrincipalName=hoge@example.com)";
            var result = searcher.FindOne();
            var user = result.GetDirectoryEntry();
            // è­˜åˆ¥åã‚’å–å¾—ã™ã‚‹
            var distinguishedName = user.Properties["distinguishedName"].Value;
            // ãƒ¡ãƒ³ãƒãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå«ã¾ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¤œç´¢ã™ã‚‹
            searcher.Filter = string.Format("(&(objectClass=group)(member={0}))", distinguishedName);
            var groups = searcher.FindAll();
            foreach (var group in groups.Cast<SearchResult>().Select(x => x.GetDirectoryEntry()))
            {
                Console.WriteLine(group.Properties["cn"].Value);
            }
        }
        Console.ReadKey();
    }

}
```

# ãŠã‚ã‚Šã«

ã‚‚ã¡ã‚ã‚“ Exchange ãŒå…¥ã£ã¦ã„ã‚Œã°æ‹¡å¼µã‚¹ã‚­ãƒ¼ãƒã‚‚åŒã˜ã‚ˆã†ã«æ¤œç´¢ã§ãã¾ã™ã€‚
