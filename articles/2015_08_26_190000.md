---
title: "LINQ to SharePoint ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2015/8/26 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

SharePoint 2010 ã‹ã‚‰ LINQ to SharePoint ã¨ã„ã†æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¾ã§ã® `SPQuery` ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªæ¤œç´¢ã‚’ã‚ˆã‚Šç°¡å˜ã«ã™ã‚‹ä»•çµ„ã¿ã§ã€Entity Framework ã‚’ä½¿ã£ãŸã“ã¨ã®ã‚ã‚‹é–‹ç™ºè€…ã§ã‚ã‚Œã°ã€ã»ã¨ã‚“ã©é•å’Œæ„Ÿãªãä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚`SPQuery` ã§ä½¿ã‚ã‚Œã‚‹ CAML ã¯é–‹ç™ºè€…ã«ã¨ã£ã¦ç›´è¦³çš„ã§ã¯ãªã‹ã£ãŸã®ã§ã€LINQ to SharePoint ã«ã‚ˆã£ã¦ SharePoint é–‹ç™ºãŒãšã£ã¨ç°¡å˜ã«ãªã‚Šã¾ã™ã€‚
LINQ to SharePoint ã‚’ä½¿ã†ãŸã‚ã«ã¯ã€`SPMetal` ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã§ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚æ—¥æœ¬èªç’°å¢ƒã ã¨ã€ã‚³ãƒ¼ãƒ‰ã«æ—¥æœ¬èªãŒæ··ã–ã£ã¦ã—ã¾ã†ã®ã¨ã€ä¸è¦ãªãƒªã‚¹ãƒˆã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ ã‚¯ãƒ©ã‚¹ã¾ã§ä½œã£ã¦ã—ã¾ã†ã®ãŒå›°ã‚Šã‚‚ã®ã§ã™ãŒã€æ™®é€šã«ä½¿ã†ã ã‘ãªã‚‰ååˆ†ã‹ã¨æ€ã„ã¾ã™ã€‚ä»Šå›ã¯ã€`SPMetal` ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã€ã‚¼ãƒ­ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-linq-to-sharepoint

# ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°

## äº‹å‰æº–å‚™

ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ **ãƒ†ã‚¹ãƒˆ** ã¨ã„ã†åå‰ã§ç©ºã®ã‚«ã‚¹ã‚¿ãƒ  ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ã‚¯ãƒ©ã‚¹

Entity Framework ã« `DBContext` ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ã‚ˆã†ã«ã€LINQ to SharePoint ã«ã‚‚ `DataContext` ã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯æ¥ç¶šæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‹ä»£ã‚ã‚Šã«ã‚µã‚¤ãƒˆã® URL ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚ãƒªã‚¹ãƒˆã®å–å¾—ã¯ `GetList` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã„ã¾ã™ã®ã§ã€ã“ã‚Œã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚[^1]

```csharp
public class SharePointDataContext : DataContext
{

    public EntityList<Test> Tests
    {
        get { return this.GetList<Test>("ãƒ†ã‚¹ãƒˆ"); }
    }

    public SharePointDataContext(string url)
        : base(url) { }

}
```

## ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ ã‚¯ãƒ©ã‚¹

SharePoint ã«ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ã‚¿ã‚¤ãƒ—ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚Šã€LINQ to SharePoint ã§ã¯ã“ã‚Œã‚’ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ã§è¡¨ç¾ã—ã¾ã™ã€‚ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ã‚¿ã‚¤ãƒ—ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰æ´¾ç”Ÿã—ã¾ã™ã®ã§ã€ã¾ãšã¯ `Item` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
`ContentTypeAttribute` å±æ€§ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ã‚¿ã‚¤ãƒ—ã®åå‰ã¨ ID ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã®åå‰ãŒã‚µã‚¤ãƒˆã®å®šç¾©ã¨ä¸€è‡´ã—ã¦ã„ã‚Œã°ã€ã‚¯ãƒ©ã‚¹åã¯ä»»æ„ã§æ§‹ã„ã¾ã›ã‚“ã€‚

```csharp
[ContentType(Name = "ã‚¢ã‚¤ãƒ†ãƒ ", Id = "0x01")]
public class Item : ITrackEntityState, ITrackOriginalValues, INotifyPropertyChanged, INotifyPropertyChanging { ... }
```

ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã™ã‚‹ã ã‘ãªã‚‰å¿…è¦ãªã„ã®ã§ã™ãŒã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã¯ã€4 ã¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¶™æ‰¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚

- `ITrackEntityState` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®çŠ¶æ…‹ç®¡ç†ã«é–¢ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®šç¾©ã—ã¾ã™ã€‚
- `ITrackOriginalValues` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯å¤‰æ›´å‰ã®å€¤ã‚’ä¿æŒã™ã‚‹ãƒ‡ã‚£ã‚¯ã‚·ãƒ§ãƒŠãƒªã‚’å®šç¾©ã—ã¾ã™ã€‚
- `INotifyPropertyChanged` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨ `INotifyPropertyChanging` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

ãƒªã‚¹ãƒˆã®åˆ—ã¯ `ColumnAttribute` å±æ€§ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚`Storage` ã«ã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ã¯ãªããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹ã®ã‚’å¿˜ã‚Œãšã«ã€‚`Title` åˆ—ã®ä¾‹ã§ã™ãŒã€`ID` ã‚„ `Version` ã‚‚åŒæ§˜ã«å®šç¾©ã—ã¾ã™ã€‚

```csharp
private string title;

[Column(Name = "Title", Storage = "title", Required = true, FieldType = "Text")]
public virtual string Title
{
    get { return this.title; }
    set {
        if (this.title != value)
        {
            this.OnPropertyChanging("Title", this.Title);
            this.title = value;
            this.OnPropertyChanged("Title");
        }
    }
}
```

`OnPropertyChanged` ã¯ãŠãªã˜ã¿ã®å®Ÿè£…ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€`OnPropertyChanging` ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿå‰ã«å¤‰æ›´å‰ã®å€¤ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«è¿½åŠ ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

```csharp
public event PropertyChangedEventHandler PropertyChanged;

protected void OnPropertyChanged(string propertyName)
{
    var handler = this.PropertyChanged;
    if (handler != null)
    {
        handler.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }
}

public event PropertyChangingEventHandler PropertyChanging;

protected void OnPropertyChanging(string propertyName, object value)
{
    if (this.OriginalValues.ContainsKey(propertyName) != true)
    {
        this.OriginalValues.Add(propertyName, value);
    }
    var handler = this.PropertyChanging;
    if (handler != null)
    {
        handler.Invoke(this, new PropertyChangingEventArgs(propertyName));
    }
}
```

æœ€å¾Œã« `Item` ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ãŸ `Test` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚ŒãŒå®Ÿéš›ã®ãƒªã‚¹ãƒˆã®å®šç¾©ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯åˆ—ã‚’è¿½åŠ ã—ã¦ã„ãªã„ã®ã§ãã®ã¾ã¾ã§ã™ãŒã€åˆ—ã‚’è¿½åŠ ã—ãŸå ´åˆã¯ã€`Item` ã‚¯ãƒ©ã‚¹ã®ä¾‹ã¨åŒæ§˜ã«è¨­å®šã§ãã¾ã™ã€‚

```csharp
[ContentTypeAttribute(Name = "ãƒ†ã‚¹ãƒˆ", Id = "0x01")]
public class Test : Item { ... }
```

# å®Ÿè¡Œçµæœ

ã‚µãƒ³ãƒ—ãƒ« ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚

```csharp
private static void Main(string[] args)
{
    using (var context = new SharePointDataContext("http://sharepoint.examle.com"))
    {
        var item1 = new Test() { Title = "ã‚¿ã‚¤ãƒˆãƒ« 1" };
        var item2 = new Test() { Title = "ã‚¿ã‚¤ãƒˆãƒ« 2" };
        var item3 = new Test() { Title = "ã‚¿ã‚¤ãƒˆãƒ« 3" };
        context.Tests.InsertOnSubmit(item1);
        context.Tests.InsertOnSubmit(item2);
        context.Tests.InsertOnSubmit(item3);
        context.SubmitChanges();
        foreach (var item in context.Tests)
        {
            Console.WriteLine("{0}:{1}", item.ID, item.Title);
        }
        Console.ReadLine();
    }
}
```

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
1:ã‚¿ã‚¤ãƒˆãƒ« 1
2:ã‚¿ã‚¤ãƒˆãƒ« 2
3:ã‚¿ã‚¤ãƒˆãƒ« 3
```

[^1]: ãƒªã‚¹ãƒˆåã®æŒ‡å®šãŒè¡¨ç¤ºåã ã‘ã§ URL ã‚„å†…éƒ¨åã¯æŒ‡å®šã§ããªã„ã‚ˆã†ã§ã™ã€‚
