---
title: "SharePoint ã§ ClosedXML ã‚’ä½¿ã£ã¦ Excel ã¸ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2015/6/17 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

:::message alert
2015/6/23 è¿½è¨˜: ã‚³ãƒ¼ãƒ‰ã«ãƒã‚°ãŒã‚ã£ãŸã®ã§ä¿®æ­£ã—ã¾ã—ãŸã€‚
:::

:::message alert
2016/2/22 è¿½è¨˜: HTML ã®è§£æã« SgmlReader ã‚’ä½¿ã†ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
:::

# ã¯ã˜ã‚ã«

SharePoint ã®æ¨™æº–æ©Ÿèƒ½ã§ã‚‚ãƒªã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã®ã§ã™ãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ClosedXML ã‚’ä½¿ã£ã¦ãƒªã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-farm-solution-export-to-spreadsheet

# ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°

## Elements/Elements.xml

æ—¢å­˜ã® **Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ä»Šå›ã¯ `RegistrationId` ã‚’ `104` ã«ã—ãŸã®ã§ã€ãŠçŸ¥ã‚‰ã›ãƒªã‚¹ãƒˆã«é©ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ `Layouts/ExportToSpreadsheet/Export.aspx` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

```xml
<?xml version="1.0" encoding="utf-8"?>
<Elements xmlns="http://schemas.microsoft.com/sharepoint/">
    <CustomAction
        Id="ExportToSpreadsheetAction"
        RegistrationId="104"
        RegistrationType="List"
        Location="CommandUI.Ribbon"
        Sequence="20"
        Title="Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
        <CommandUIExtension>
            <CommandUIDefinitions>
                <CommandUIDefinition Location="Ribbon.List.Actions.ExportToSpreadsheet">
                    <Button
                        Id="Ribbon.List.Actions.ExportToSpreadsheet"
                        Alt="Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"
                        Sequence="20"
                        Command="ExportToSpreadsheetCommand"
                        Image32by32="/_layouts/15/images/XLS32.GIF"
                        Image16by16="/_layouts/15/images/XLS16.GIF"
                        LabelText="Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"
                        TemplateAlias="o1" />
                </CommandUIDefinition>
            </CommandUIDefinitions>
            <CommandUIHandlers>
                <CommandUIHandler
                  Command="ExportToSpreadsheetCommand"
                  CommandAction="/_layouts/ExportToSpreadsheet/Export.aspx?ListId={ListId}" />
            </CommandUIHandlers>
        </CommandUIExtension>
    </CustomAction>
</Elements>
```

## Layouts/ExportToSpreadsheet/Export.aspx.cs

`Page_Load` ã‚¤ãƒ™ãƒ³ãƒˆã§ã€GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§å—ã‘å–ã£ãŸãƒªã‚¹ãƒˆ ID ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸€è¦§ã‚’ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™ã€‚
ã“ã“ã§ã¡ã‚‡ã£ã¨ã‚³ãƒ„ãªã®ã§ã™ãŒã€ãŠçŸ¥ã‚‰ã›ãƒªã‚¹ãƒˆã®æœ¬æ–‡ã¯è¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆã§å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å†…éƒ¨çš„ã«ã¯ HTML ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€HTML ã‚’è§£æã—ã¦æ›¸å¼ã‚’æŒ‡å®šã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã“ã§ç°¡å˜ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```csharp
public partial class Export : LayoutsPageBase
{

    protected void Page_Load(object sender, EventArgs e)
    {
        var listId = this.Request.QueryString["ListId"];
        using (var web = SPContext.Current.Web)
        {
            var list = web.Lists[new Guid(listId)];
            using (var workbook = new XLWorkbook())
            using (var stream = new MemoryStream())
            {
                var worksheet = workbook.Worksheets.Add("Sheet1");
                for (var index = 0; index < list.Items.Count; index++)
                {
                    var item = list.Items[index];
                    worksheet.Cell(index + 1, 1).SetValue(item["ID"]);
                    worksheet.Cell(index + 1, 2).SetValue(item["Title"]);
                    worksheet.Cell(index + 1, 3).SetHtmlValue(item["Body"]);
                }
                workbook.SaveAs(stream);
                this.Response.Clear();
                this.Response.AppendHeader("Content-Type", "application/vnd.ms-excel");
                this.Response.AppendHeader("Content-Disposition", "attachment; filename=text.xlsx");
                this.Response.BinaryWrite(stream.ToArray());
                this.Response.End();
            }
        }
    }
}
```

## Extensions/XLCellExtension

ClosedXML ã§ã¯ `RichText` ã‚’ `Substring` ã—ã¦æ›¸å¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€HTML ã‚’è§£æã—ã¦æ›¸å¼ã‚’è¨­å®šã—ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšã€æ–‡å­—è‰²ã¨å¼·èª¿ã ã‘å®Ÿè£…ã—ã¾ã—ãŸãŒã€ãã®ä»–ã®æ›¸å¼ã‚‚åŒæ§˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

```csharp
public static class XLCellExtension
{

    public static IXLCell SetHtmlValue(this IXLCell target, string html)
    {
        var reader = new SgmlReader();
        reader.DocType = "HTML";
        reader.WhitespaceHandling = WhitespaceHandling.None;
        reader.InputStream = new StringReader(html);
        var xmlRoot = new XmlDocument();
        xmlRoot.Load(reader);
        target.SetValue(xmlRoot.InnerText);
        var rootText = xmlRoot.InnerXml;
        var spanIndex = 0;
        foreach (var item in xmlRoot.GetElementsByTagName("span").Cast<XmlElement>())
        {
            var itemText = item.OuterXml;
            var rawStart = rootText.IndexOf(itemText, spanIndex);
            var rawLength = itemText.Length;
            var trimStart = Regex.Replace(rootText.Substring(0, rawStart), "<.+?>", "").Length;
            var trimLength = item.InnerText.Length;
            var richText = target.RichText.Substring(trimStart, trimLength);
            richText.SetCssStyle(item);
            spanIndex = rawStart + rawLength;
        }
        var strongIndex = 0;
        foreach (var item in xmlRoot.GetElementsByTagName("strong").Cast<XmlElement>())
        {
            var itemText = item.OuterXml;
            var rawStart = rootText.IndexOf(itemText, strongIndex);
            var rawLength = itemText.Length;
            var trimStart = Regex.Replace(rootText.Substring(0, rawStart), "<.+?>", "").Length;
            var trimLength = item.InnerText.Length;
            var richText = target.RichText.Substring(trimStart, trimLength);
            richText.SetBold();
            richText.SetCssStyle(item);
            strongIndex = rawStart + rawLength;
        }
        return target;
    }

    public static void SetCssStyle<T>(this IXLFormattedText<T> richText, XmlElement element)
    {
        var xmlStyle = element.GetAttribute("style");
        if (string.IsNullOrEmpty(xmlStyle) != true)
        {
            var cssStyles = xmlStyle.Split(';').Select(str =>
            {
                var pair = str.Split(':');
                pair[0] = pair[0].Trim();
                pair[1] = pair[1].Trim();
                return Tuple.Create(pair[0], pair[1]);
            });
            var cssColor = cssStyles.FirstOrDefault(pair => pair.Item1 == "color");
            if (cssColor != null)
            {
                richText.SetFontColor(XLColor.FromHtml(cssColor.Item2));
            }
        }
    }
}
```

# å®Ÿè¡Œçµæœ

ãŠçŸ¥ã‚‰ã›ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹ã¨ **Excel ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** ã®ã‚³ãƒãƒ³ãƒ‰ãŒä¸Šæ›¸ãã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
