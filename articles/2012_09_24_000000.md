---
title: "UpdateModel ã§å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚‚å«ã‚ã¦æ›´æ–°ã—ã‚ˆã†ã¨ã—ãŸã‚‰ã†ã¾ãã„ã‹ãªã‹ã£ãŸ"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "javascript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2012/9/24 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

Controller ã® `UpdateModel` (ã¾ãŸã¯ `TryUpdateModel`) ã§å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚‚å«ã‚ã¦æ›´æ–°ã—ã‚ˆã†ã¨æ€ã£ãŸã‚‰ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°

## ãƒ¢ãƒ‡ãƒ«

ä»¥ä¸‹ã®ã‚ˆã†ãªè¦ªå­é–¢ä¿‚ã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”¨æ„ã—ã¾ã™ã€‚

### Models/Group.cs

```csharp
public class Group
{

    [Key()]
    public int Id { get; set; }

    [Required()]
    [StringLength(64)]
    public string Name { get; set; }

    public ICollection<Member> Members { get; set; }

    public Group()
    {
        this.Members = new HashSet<Member>();
    }

}
```

### Models/Member.cs

```csharp
public class Member
{

    [Key()]
    public int Id { get; set; }

    [ForeignKey("Group")]
    public int GroupId { get; set; }

    public Group Group { get; set; }

    [Required()]
    [StringLength(64)]
    public string Name { get; set; }

}
```

## ãƒ“ãƒ¥ãƒ¼

### Views/Home/Index.cshtml

å°‘ã€…é•·ã„ã§ã™ãŒã”å®¹èµ¦ãã ã•ã„ã€‚å…ˆã»ã©ä½œã£ãŸ `Group` ã¨ `Member` ã‚’ä¸€æ‹¬æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã¯ knockout.js ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
**æ¤œç´¢** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã€`ID` ã§ `Group` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
**æ›´æ–°** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã€ç”»é¢ã®æƒ…å ±ã‚’ jQuery ã® ajax ãƒ¡ã‚½ãƒƒãƒ‰ã§é€ä¿¡ã—ã¾ã™ã€‚MIME ã‚’ `application/json` ã¨ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```html
@model Karamem0.samples.Models.Group
@{
    ViewBag.Title = "ãƒ›ãƒ¼ãƒ ";
}
@using (Html.BeginForm()) {
    <fieldset>
        <table>
            <tbody>
                <tr>
                    <td class="editor-label">@Html.LabelFor(model => model.Id)
                    </td>
                    <td class="editor-field">
                        @Html.TextBoxFor(model => model.Id, new Dictionary<string, object>() {
                            { "data-bind", "value: id" },
                        })
                        <input type="button" value="æ¤œç´¢" data-bind="click: search" />
                    </td>
                </tr>
                <tr>
                    <td class="editor-label">@Html.LabelFor(model => model.Name)
                    </td>
                    <td class="editor-field">
                        @Html.TextBoxFor(model => model.Name, new Dictionary<string, object>() {
                            { "data-bind", "value: name" },
                        })
                    </td>
                </tr>
            </tbody>
        </table>
    </fieldset>
    <fieldset>
        <table>
            <thead>
                <tr>
                    <td class="header-label" colspan="2">
                        <input type="button" value="è¿½åŠ " data-bind="click: add" />
                    </td>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <td class="header-label" colspan="2">
                        <input type="button" value="æ›´æ–°" data-bind="click: update" />
                    </td>
                </tr>
            </tfoot>
            <tbody data-bind="foreach: members">
                <tr>
                    <td class="editor-label">@Html.LabelFor(model => Model.Members.FirstOrDefault().Name)
                    </td>
                    <td class="editor-field">
                        @Html.HiddenFor(model => Model.Members.FirstOrDefault().Id)
                        @Html.TextBoxFor(model => Model.Members.FirstOrDefault().Name, new Dictionary<string, object>() {
                            { "data-bind", "value: name" },
                        })
                        <input type="button" value="å‰Šé™¤" data-bind="click: $parent.remove" />
                    </td>
                </tr>
            </tbody>
        </table>
    </fieldset>
}
<script type="text/javascript">
    function ViewModel() {

        var self = this;

        this.id = ko.observable(0);
        this.name = ko.observable("");
        this.members = ko.observableArray([]);

        this.search = function () {
            var url = "@Url.Action("Search")";
            var param = { Id: self.id() };
            var callback = function(data) {
                if (data != null) {
                    self.id(data.Id);
                    self.name(data.Name);
                    self.members.removeAll();
                    $.each(data.Members, function(i, e) {
                        self.members.push({
                            id: e.Id,
                            name: e.Name
                        });
                    });
                }
            };
            $.post(url, param, callback, "json");
        };

        this.update = function() {
            var url = "@Url.Action("Update")";
            var param = {
                Id: self.id(),
                Name: self.name(),
                Members: Enumerable.From(self.members())
                    .Select(function(member) { return {
                        Id: member.id,
                        Name: member.name
                    }})
                    .ToArray()
            };
            var callback = function(data) {
                if (data != null) {
                    self.id(data.Id);
                }
            };
            $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                processData: false,
                traditional: true,
                success: callback,
                data: JSON.stringify(param),
                dataType: "json"
            });
        };

        this.add = function() {
            self.members.push({
                id: 0,
                name: null
            });
        };

        this.remove = function(item) {
            self.members.remove(item);
        };

    };
    $(function () {
        ko.applyBindings(new ViewModel());
    });
</script>
```

è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

![](/images/2012_09_24_000000_001.png)

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

### Controllers/HomeController.cs

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã® `Update` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã° `DbContext` ã«è¿½åŠ ã—ã€ã‚ã‚Œã° `UpdateModel` ã§æ›´æ–°ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```csharp
public class HomeController : Controller
{

    [HttpGet()]
    public ActionResult Index()
    {
        return this.View();
    }

    [HttpPost()]
    public ActionResult Search(int id)
    {
        using (var context = new EntityContext())
        {
            var model = context.Groups
                .Include(x => x.Members)
                .SingleOrDefault(x => x.Id == id);
            if (model != null) {
                model.Members.ToList().ForEach(x => x.Group = null);
            }
            return this.Json(model);
        }
    }

    [HttpPost()]
    public ActionResult Update(Group model)
    {
        using (var context = new EntityContext())
        {
            if (this.ModelState.IsValid) {
                model = context.Groups
                    .Include(x => x.Members)
                    .SingleOrDefault(x => x.Id == model.Id);
                if (model == null) {
                    model = new Group();
                    this.UpdateModel(model);
                    context.Groups.Add(model);
                } else {
                    this.UpdateModel(model);
                }
                context.SaveChanges();
            }
        }
        model.Members.ToList().ForEach(x => x.Group = null);
        return this.Json(model);
    }

}
```

# å®Ÿè¡Œçµæœ

ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ç™»éŒ²ã—ã¦ã¿ã¾ã™ã€‚

![](/images/2012_09_24_000000_002.png)

ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã‚‹ã¨ç”»é¢ã® `ID` ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚

![](/images/2012_09_24_000000_003.png)

ã—ã‹ã—ã€ã“ã®çŠ¶æ…‹ã§ã‚‚ã†ä¸€åº¦æ›´æ–°ã™ã‚‹ã¨ã€ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã™ã€‚

> System.InvalidOperationException: 'The operation failed: The relationship could not be changed because one or more of the foreign-key properties is non-nullable. When a change is made to a relationship, the related foreign-key property is set to a null value. If the foreign-key does not support null values, a new relationship must be defined, the foreign-key property must be assigned another non-null value, or the unrelated object must be deleted.'

ãŠãã‚‰ã `UpdateModel` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è‡ªä½“ãŒæ›¸ãæ›ã‚ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ã« `Deleted` ã®ãƒ•ãƒ©ã‚°ãŒã†ã¾ãç«‹ãŸãªã„ã¿ãŸã„ã§ã™ã€‚

# ãŠã‚ã‚Šã«

ã¨ã‚Šã‚ãˆãšã„ã£ãŸã‚“å…¨éƒ¨ `Delete` ã—ã¦ã‹ã‚‰è¿½åŠ ã™ã‚‹ã‚ˆã†ã«é€ƒã’ã¾ã—ãŸãŒã€ã‚ªãƒ¼ãƒˆ ãƒŠãƒ³ãƒãƒ¼ã ã¨ `ID` ã‚‚å¤‰ã‚ã£ã¦ã—ã¾ã†ã®ã§ã‚ã¾ã‚Šã„ã„æ–¹æ³•ã˜ã‚ƒãªã„ã®ã§ã€ä½•ã‹è§£æ±ºæ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ã»ã—ã„ã§ã™ã€‚
