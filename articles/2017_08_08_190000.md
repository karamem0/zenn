---
title: "SharePoint Framework (SPFx) ã‹ã‚‰ Office 365 API ã‚’å©ã„ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["azuread", "sharepoint", "typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2017/8/8 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

SharePoint Framework (SPFx) ã® Web ãƒ‘ãƒ¼ãƒ„ã§ã¯æ–°ã—ã„ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ãŒæ¡ç”¨ã•ã‚Œã€ã“ã‚Œã¾ã§ã® SharePoint ã‚¢ãƒ‰ã‚¤ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ãŸ `iframe` ãŒå»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚SharePoint ã‚¢ãƒ‰ã‚¤ãƒ³ã§ã¯ OAuth2 ã®æš—é»™çš„ãªè¨±å¯ãƒ•ãƒ­ãƒ¼ã§ã†ã¾ã„ã“ã¨ `iframe` å†…ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã§ããŸã®ã§ã™ãŒã€SPFx ã§ã¯ãã‚ŒãŒã§ããªããªã‚Šã¾ã—ãŸã€‚ã•ã¦å›°ã£ãŸã¨ã„ã†ã“ã¨ã§é ‘å¼µã£ã¦ãªã‚“ã¨ã‹ã—ã¦ã¿ã¾ã—ãŸã€‚

å¿µã®ãŸã‚å…¬å¼ã®å¯¾å¿œæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/sharepoint/dev/spfx/web-parts/guidance/connect-to-api-secured-with-aad?WT.mc_id=M365-MVP-5002941

`adal.js` ãŒ Web ãƒ‘ãƒ¼ãƒ„ã«å¯¾å¿œã—ã¦ã„ãªã„ã‹ã‚‰ `AuthenticationContext` ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚ã¨ã‹ãã‚Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å¯¾å¿œã™ã‚‹è©±ã˜ã‚ƒãªã„ã‚“ã§ã™ã‹ã­ã€‚ç„¡ç†ã—ã¦ `adal.js` ã‚’ä½¿ã†ã“ã¨ã‚‚ãªã„ã®ã§ä»Šå›ã¯ä½¿ã‚ãšã«å®Ÿè£…ã—ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-framework-read-mail-folder

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç™»éŒ²

Azure AD ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID ã‚’æ§ãˆã¦ãŠãã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã« Exchange Online ã® `Mail.Read` ã‚’é¸æŠã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

SharePoint Framework ã‚’ä½¿ã†ã¾ã§ã®æµã‚Œã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://docs.microsoft.com/ja-jp/sharepoint/dev/spfx/set-up-your-development-environment?WT.mc_id=M365-MVP-5002941

`yeoman` ã‚’ä½¿ã£ã¦é©å½“ãªåå‰ (ä»Šå›ã¯ `MyApplication`) ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ç¾æ™‚ç‚¹ã§ã¯ `MyApplicationWebPart.manifest.json` ã«ãƒã‚°ãŒã‚ã£ã¦ `$schema` ã®ãƒ‘ã‚¹ãŒé€šã£ã¦ã„ã¾ã›ã‚“ã€‚ãã“ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ `clientSideComponentManifestSchema.json` ã‹ã‚‰ `client-side-component-manifest.schema.json` ã«å¤‰æ›´ã—ã¾ã™ã€‚

## Web ãƒ‘ãƒ¼ãƒ„ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä½œæˆ

åˆ¥ã«å®šæ•°ã§ã‚‚ã„ã„ã®ã§ã™ãŒã›ã£ã‹ããªã®ã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½œæˆã—ã¾ã™ã€‚

### IMyApplicationWebPartProps.ts

```javascript
export interface IMyApplicationWebPartProps {
    appId: string;
    authUrl: string;
    resourceUrl: string;
}
MyApplicationWebPart.manifest.json
{
    "preconfiguredEntries": [
        {
            "properties": {
                "appId": "{{app-id}}",
                "authUrl": "https://login.microsoftonline.com/common/oauth2/authorize",
                "resourceUrl": "https://outlook.office.com"
            }
        }
    ]
}
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä½œæˆ

ä¸€åº¦å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ `sessionStorage` ã«ä¿å­˜ã—ã¦ãŠãã‚ˆã†ã«ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã§ Web ãƒ‘ãƒ¼ãƒ„ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ ID ã‚’å—ã‘å–ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã® Web ãƒ‘ãƒ¼ãƒ„ãŒã‚ã£ãŸå ´åˆã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ãŒç«¶åˆã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

### IMyApplicationUserProps.ts

```javascript
export class MyApplicationUserProps {

    private instanceId: string;

    constructor(instanceId: string) {
        this.instanceId = instanceId;
    }

    public get accessToken(): string {
        return this._getValue("accessToken");
    }

    public set accessToken(value: string) {
        this._setValue("accessToken", value);
    }

    private _getValue(key: string): string {
        var stringValue = sessionStorage.getItem(this.instanceId);
        if (stringValue == null) {
            return null;
        }
        var jsonValue = JSON.parse(stringValue);
        return jsonValue[key];
    }

    private _setValue(key: string, value: string): void {
        var stringValue = sessionStorage.getItem(this.instanceId);
        if (stringValue == null) {
            stringValue = "{}";
        }
        var jsonValue = JSON.parse(stringValue);
        jsonValue[key] = value;
        stringValue = JSON.stringify(jsonValue);
        sessionStorage.setItem(this.instanceId, stringValue);
    }

}
```

## OAuth ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ

ä¸Šè¨˜ã«ã‚‚ã‚ã‚‹é€šã‚Š `iframe` ã«ã‚ˆã‚‹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã§ããªã„ã®ã§ `window.open()` ã§æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å‘¼ã³å‡ºã—å…ƒã§ã¯ `setInterval()` ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ã‚’ç›£è¦–ã—ã€ãƒ•ãƒ­ãƒ¼ãŒçµ‚ã‚ã£ãŸã‚‰ URL ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚å–å¾—ãŒçµ‚ã‚ã£ãŸã‚‰ Outlook Mail REST API ã‚’å©ã„ã¦æœªèª­ä»¶æ•°ã‚’å–å¾—ã—ã¾ã™ã€‚

### MyApplicationWebPart.ts

```javascript
public render(): void {
    this.userProperties = new MyApplicationUserProps(this.context.instanceId);
    if (window.location.hash == "") {
        var loginName = this.context.pageContext.user.loginName;
        if (this.userProperties.loginName != loginName) {
            this.userProperties.clear();
            this.userProperties.loginName = loginName;
        }
        if (this.userProperties.accessToken == null) {
            var redirectUrl = window.location.href.split("?")[0];
            var requestUrl = this.properties.authUrl + "?" +
                "response_type=token" + "&" +
                "client_id=" + encodeURI(this.properties.appId) + "&" +
                "resource=" + encodeURI(this.properties.resourceUrl) + "&" +
                "redirect_uri=" + encodeURI(redirectUrl);
            var popupWindow = window.open(requestUrl, this.context.instanceId, "width=600px,height=400px");
            var handle = setInterval((self) => {
                if (popupWindow == null || popupWindow.closed == null || popupWindow.closed == true) {
                    clearInterval(handle);
                }
                try {
                    if (popupWindow.location.href.indexOf(redirectUrl) != -1) {
                        var hash = popupWindow.location.hash;
                        clearInterval(handle);
                        popupWindow.close();
                        var query = {};
                        var elements = hash.slice(1).split("&");
                        for (var index = 0; index < elements.length; index++) {
                            var pair = elements[index].split("=");
                            var key = decodeURIComponent(pair[0]);
                            var value = decodeURIComponent(pair[1]);
                            query[key] = value;
                        }
                        self.userProperties.accessToken = query["access_token"];
                        self.userProperties.expiresIn = query["expires_in"];
                        self._renderBody();
                        self._renderContent();
                    }
                } catch (e) { }
            }, 1, this);
        } else {
            this._renderBody();
            this._renderContent();
        }
    }
}

private _renderBody(): void {
    this.domElement.innerHTML = `
        <div id="${this.context.manifest.id}" class="${styles.container}">
        </div>`;
}

private _renderContent(): void {
    var container = this.domElement.querySelector(`#${this.context.manifest.id}`);
    var requestUrl = this.properties.resourceUrl + "/api/v2.0/me/mailfolders";
    fetch(requestUrl, {
        method: "GET",
        headers: new Headers({
            "Accept": "application/json",
            "Authorization": `Bearer ${this.userProperties.accessToken}`
        })
    })
        .then(response => response.json())
        .then(data => {
            var items = data.value;
            for (var index = 0; index < items.length; index++) {
                var displayName = items[index].DisplayName;
                var unreadItemCount = items[index].UnreadItemCount;
                container.innerHTML += `<div>${displayName}: ${unreadItemCount}</div>`;
            }
        });
}
```

# å®Ÿè¡Œçµæœ

åˆå›ã®ã¿æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚æ¬¡å›ä»¥é™ã¯ä¿å­˜ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ãŒä½¿ã‚ã‚Œã‚‹ãŸã‚ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

![](/images/2017_08_08_190000_001.png)

# ãŠã‚ã‚Šã«

ã‚‚ã—ã‹ã—ãŸã‚‰å‹•çš„ã« `iframe` ã‚’ä½œã£ã¦ãƒ•ãƒ­ãƒ¼ã‚’å‡¦ç†ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã‹ã‚‚ã€‚
