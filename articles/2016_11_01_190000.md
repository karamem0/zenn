---
title: "ASP.NET MVC ã® Repository ãƒ‘ã‚¿ãƒ¼ãƒ³å†è€ƒ"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2016/11/1 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

:::message alert
2018/5/22 è¿½è¨˜: [ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/karamem0/articles/2018_05_22_120000) ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚
:::

# ã¯ã˜ã‚ã«

ASP.NET MVC ãŒå‡ºå§‹ã‚ãŸé ƒã€Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè©±é¡Œã«ãªã‚Šã¾ã—ãŸã€‚ãã®å¾Œã€ã‚ã¾ã‚Š Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã®è­°è«–ãŒã•ã‚Œã¦ã„ãªã„ã‚ˆã†ãªã®ã§ã€æ”¹ã‚ã¦ Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åŸºæœ¬

Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç›®çš„ã¯ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŠ½è±¡åŒ–ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```csharp
public interface IRepository<T>
{

    T GetOne(int id);

    IEnumerable<T> GetAll();

    void Add(T item);

    void Update(T item);

    void Delete(T item);

}
```

`IRepository` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’å®Ÿè£…ã— Entity Framework ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```csharp
public class PersonRepository : IRepository<Person>
{

    private DbContext dbContext;

    public PersonRepository()
    {
        this.dbContext = new SampleDbContext();
    }

    public Person GetOne(int id)
    {
        return this.dbContext.Set<Person>().Find(id);
    }

    public IEnumerable<Person> GetAll()
    {
        return this.dbContext.Set<Person>().AsEnumerable();
    }

    public void Add(Person item)
    {
        this.dbContext.Set<Person>.Add(item);
        this.dbContext.SubmitChanges();
    }

    public void Update(Person item)
    {
        this.dbContext.SubmitChanges();
    }

    public void Delete(Person item)
    {
        this.dbContext.Set<Person>.Remove(item);
        this.dbContext.SubmitChanges();
    }

}
```

Repository ã‚’æ“ä½œã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

```csharp
public class SalaryService
{

    private IRepository<Person> personRepository;

    public class SomeService()
    {
        this.personRepository = new PersonRepository();
    }

    public class SomeService(IRepository<Person> personRepository)
    {
        this.personRepository = personRepository;
    }

    public IEnumerable<Salary> GetSalaries()
    {
        // ä½•ã‹ã—ã‚‰ã®ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯
    }

}
```

ã“ã®ã‚¯ãƒ©ã‚¹ã§ã¯ã€æŠ½è±¡åŒ–ã•ã‚ŒãŸ IRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã€ãƒ¢ãƒƒã‚¯ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¾å­˜ã—ãªã„å˜ä½“ãƒ†ã‚¹ãƒˆ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```csharp
[TestClass()]
public class SalaryServiceTest
{

    [TestMethod()]
    public void GetSalariesTest()
    {
        var data = new [] { new Person() };
        var mock = new Mock<IRepository<Person>>();
        mock.Setup(repos => repos.GetAll())
            .Returns(data);
        var target = new SalaryService(mock.Object);
        var actual = target.GetSalaries();
    }

}
```

# IRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å¿…è¦æ€§

ãã‚‚ãã‚‚ã¨ã—ã¦ã€ŒIRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯å¿…è¦ã‹ï¼Ÿã€ã¨ã„ã†è©±ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ¢ãƒƒã‚¯ã—ãŸã„ã€ã¤ã¾ã‚Šå˜ä½“ãƒ†ã‚¹ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ†é›¢ã—ãŸã„ç†ç”±ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ç†ç”±ãŒæŒ™ã’ã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

- æ¥ç¶šæ–‡å­—åˆ—ã«å›ºæœ‰ã®æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ ã‚µãƒ¼ãƒãƒ¼ã«æŒã£ã¦ã„ã£ãŸã¨ãã«è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå®Ÿæ–½ã§ããªã„
- é€£ç¶šå®Ÿè¡Œã—ãŸå ´åˆãªã©ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã£ã¦ã€ãƒ†ã‚¹ãƒˆçµæœãŒå·¦å³ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

SQL Server LocalDB ã‚’ä½¿ãˆã°ã€å˜ä½“ã® `mdf` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‹•ä½œã™ã‚‹ã®ã§ã€ç’°å¢ƒã«ã‚ˆã‚‹ä¾å­˜æ€§ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸ CI ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ AppVeyor ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã®ã§ã€ãƒ“ãƒ«ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã§ã‚‚è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’é€šã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```xml
<connectionStrings>
    <add name="DefaultConnection"
         connectionString="Data Source=(localdb)\mssqllocaldb; Initial Catalog=sampledb; AttachDbFilename=|DataDirectory|\sampledb.mdf; Integrated Security=True;"
         providerName="System.Data.SqlClient" />
</connectionStrings>
```

```csharp
[ClassInitialize()]
public static void ClassInitialize(TestContext testContext)
{
    AppDomain.CurrentDomain.SetData("DataDirectory", testContext.TestDeploymentDir);
}
```

`App.config` ã« DataDirectory ã‚’æŒ‡å®šã—ã€ãƒ†ã‚¹ãƒˆ ã‚¯ãƒ©ã‚¹ã§å˜ä½“ãƒ†ã‚¹ãƒˆã® `TestDeploymentDir` ã«æ›¸ãæ›ãˆã¦ã‚ã’ã‚Œã°ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½ã”ã¨ã«ç•°ãªã‚‹ `mdf` ãŒä½¿ã‚ã‚Œã¾ã™ã€‚ã‚ã¨ã¯ Code First ã§ã‚ã‚Œã° `Database.Create()` ã™ã‚‹ã ã‘ã§ã™ã€‚ã‚ã–ã‚ã–ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã‚ãªãã¦ã‚‚ã€ã»ã¨ã‚“ã©ã®å ´åˆã¯ã€ã“ã¡ã‚‰ã®ã»ã†ãŒç°¡å˜ã«å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã§ãã‚‹ã¯ãšã§ã™ã€‚

ã©ã†ã—ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã„ãŸããªã„å ´åˆã§ã‚‚ã€Entity Framework ã® `DbContext` ã‚¯ãƒ©ã‚¹ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ã—ã¾ã†ã¨ã„ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã¨ã„ã†ã®ã‚‚ã€`DbContext` ã‚¯ãƒ©ã‚¹ã¯ã™ã§ã« Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

`DbContext` ã‚¯ãƒ©ã‚¹ã¨ `DbSet` ã‚¯ãƒ©ã‚¹ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚Œã°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```csharp
[TestClass()]
public class SalaryServiceTest
{

    [TestMethod()]
    public void GetSalariesTest()
    {
        var mockData = new List<Person>() { new Person() };
        var mockDbSet = new Mock<DbSet<Person>>();
        mockDbSet.As<IEnumerable<Person>>()
            .Setup(dbSet => dbSet.GetEnumerator())
            .Returns(mockData.GetEnumerator());
        var mockDbContext = new Mock<DbContext>();
        mockDbContext.Setup(dbContext => dbContext.Set<Person>())
            .Returns(mockDbSet);
        var target = new SalaryService(mockDbContext.Object);
        var actual = target.GetSalaries();
    }

}
```

# ãã‚Œã§ã‚‚ IRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ä½¿ã†ç†ç”±

ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…ãšã—ã‚‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚REST ã‚„ OData ãª Web API ã®å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ ã‚¹ãƒˆã‚¢ã«é™å®šã•ã‚Œãªã„å ´åˆã€IRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–ã—ã¦ãŠãã¨ã€ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰ã¯ãƒ‡ãƒ¼ã‚¿ ã‚¹ãƒˆã‚¢ã®ç¨®é¡ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãªãã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã¾ã™ã€‚

```csharp
public class OfferRepository : IRepository<Offer>
{

    private const string BaseUrl = "http://example.com/Offers";

    public OfferRepository() { }

    public Offer GetOne(int id)
    {
        var webRequest = WebRequest.Create(BaseUrl + "/" + item.Id);
        webRequest.Method = "GET";
        var webResponse = webRequest.GetResponse();
        using (var stream = webResponse.GetResponseStream())
        {
            var serializer = new JsonSerializer();
            using (var reader = new JsonTextReader(new StreamReader(stream)))
            {
                return serializer.Deserialize<Offer>(stream);
            }
        }
    }

    public IEnumerable<Offer> GetAll()
    {
        var webRequest = WebRequest.Create(BaseUrl);
        webRequest.Method = "GET";
        var webResponse = webRequest.GetResponse();
        using (var stream = webResponse.GetResponseStream())
        {
            var serializer = new JsonSerializer();
            using (var reader = new JsonTextReader(new StreamReader(stream)))
            {
                return serializer.Deserialize<IEmumerable<Offer>>(stream);
            }
        }
    }

    public void Add(Offer item)
    {
        var webRequest = WebRequest.Create(BaseUrl);
        webRequest.Method = "POST";
        webRequest.ContentType = "application/json";
        using (var stream = webRequest.GetRequestStream())
        {
            var serializer = new JsonSerializer();
            using (var writer = new JsonTextWriter(new StreamWriter(stream)))
            {
                serializer.Serialize(writer, item);
            }
        }
        webRequest.GetResponse();
    }

    public void Update(Offer item)
    {
        var webRequest = WebRequest.Create(BaseUrl + "/" + item.Id);
        webRequest.Method = "PUT";
        webRequest.ContentType = "application/json";
        using (var stream = webRequest.GetRequestStream()) {
            var serializer = new JsonSerializer();
            using (var writer = new JsonTextWriter(new StreamWriter(stream)))
            {
                serializer.Serialize(writer, item);
            }
        }
        webRequest.GetResponse();
    }

    public void Delete(Offer item)
    {
        var webRequest = WebRequest.Create(BaseUrl + "/" + item.Id);
        webRequest.Method = "DELETE";
        webRequest.GetResponse();
    }

}
```

# Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©åˆ‡ã«å®Ÿè£…ã™ã‚‹ãŸã‚ã«

æ±ç”¨ã® `IRepository` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹å®Ÿè£…ã§ã¯ã€ã‚¯ã‚¨ãƒªå‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ã—ã¾ã„ãŒã¡ã§ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯é–“é•ã„ã§ã™ã€‚

```csharp
public class SalaryService
{

    private IRepository<Person> personRepository;

    public class SomeService()
    {
        this.personRepository = new PersonRepository();
    }

    public class SomeService(IRepository<Person> personRepository)
    {
        this.personRepository = personRepository;
    }

    public decimal GetSalary(string name)
    {
        // ã“ã®ä¾‹ã®ã‚ˆã†ã«ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚¯ã‚¨ãƒªã‚’æ›¸ã„ãŸã‚‰é§„ç›®
        return this.personRepository.GetAll()
            .Where(person => person.Name == name)
            .Select(person => person.Salary)
            .Single();
    }

}
```

`GetAll` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `IEnumerable` ã‚’è¿”ã—ã¾ã™ã®ã§ã€Entity Framework ã§ã¯æ„å›³ã—ãªã„ SQL ãŒæµã‚Œã¦ã—ã¾ã†çµæœã«ãªã‚Šã¾ã™ã€‚

http://itkaeru.blogspot.jp/2012/09/c-ienumerable-iqueryable.html

ã‹ã¨ã„ã£ã¦ã€`GetAll` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ `IQueryable` ã«ã—ã¦ã—ã¾ã†ã¨ã€ä»Šåº¦ã¯ã›ã£ã‹ãåˆ†é›¢ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ä¾å­˜æ€§ãŒå¾©æ´»ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ã§ãã‚‹ã ã‘ã‚¯ã‚¨ãƒªå‡¦ç†ã¯ Repository ã®ä¸­ã«é–‰ã˜è¾¼ã‚ã¦ãŠãã€æ±ç”¨ã® `IRepository` ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã†ã¡ã€å¿…è¦ãªã„ã‚‚ã®ã¯å®Ÿè£…ã—ãªã„ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```csharp
public interface IPersonRepository
{

    decimal GetSalary(string name);

}

public class PersonRepository : IRepository<Person>, IPersonRepository
{

    private DbContext dbContext;

    public PersonRepository()
    {
        this.dbContext = new SampleDbContext();
    }

    Person IRepository<Person>.GetOne(int id)
    {
        throw new NotSupportedException();
    }

    IEnumerable<Person> IRepository<Person>.GetAll()
    {
        throw new NotSupportedException();
    }

    void IRepository<Person>.Add(Person item)
    {
        throw new NotSupportedException();
    }

    void IRepository<Person>.Update(Person item)
    {
        throw new NotSupportedException();
    }

    void IRepository<Person>.Delete(Person item)
    {
        throw new NotSupportedException();
    }

    public decimal GetSalary(string name)
    {
        // ã‚¯ã‚¨ãƒªå‡¦ç†
        return this.dbContext.Set<Person>()
            .Where(person => person.Name == name)
            .Select(person => person.Salary)
            .Single();
    }

}
```
