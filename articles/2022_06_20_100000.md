---
title: "Avanade Beef ã§ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["dotnet", "beef"]
published: true
---

# ã¯ã˜ã‚ã«

Avanade Beef ã¯ ASP.NET Core ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹ Web API ã®è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://github.com/Avanade/Beef

æ¦‚è¦ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚‚ã”è¦§ãã ã•ã„ã€‚

@[speakerdeck](084022d090bb4df38512435904e85aa9)

Avanade Beef ã¯æ—¢å®šã§ RDBMS (ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¾ãŸã¯ Entity Framework)ã€Cosmos DBã€OData ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒ ã¨ã—ã¦çµ„ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã€Microsoft Graph ã‚’ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Azure AD ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹ API ã‚’ä½œæˆã™ã‚‹ä¾‹ã‚’è¦‹ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/avanade-beef-with-microsoft-graph

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’ `None` ã¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```
dotnet new beef --company Karamem0 --appname MyApplication --datasource None
```

`Api` ãŠã‚ˆã³ `Business` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« [Microsoft.Graph](https://www.nuget.org/packages/Microsoft.Graph) ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
dotnet add package Microsoft.Graph
```

## ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

### entity.beef.yaml

ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’è¿”ã™ã®ã§ `getAll: true` ã¨ã—ã¾ã™ã€‚ã¾ãŸãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã¯ã‚«ã‚¹ã‚¿ãƒ ã§å®Ÿè£…ã™ã‚‹ã®ã§ `autoImplement: None` ã¨ã™ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

```yaml
entityScope: Autonomous
appBasedAgentArgs: true
webApiAutoLocation: true
eventOutbox: None
entities:
  - name: User
    getAll: true
    collection: true
    collectionResult: true
    webApiRoutePrefix: users
    autoImplement: None
    properties:
      - name: Id
        type: Guid
        uniqueKey: true
      - name: UserPrincipalName
        type: string
      - name: DisplayName
        type: string
```

ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```
dotnet run all
```

### Business/Data/UserData.cs

`autoImplement: None` ã¨ã—ãŸã®ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ UserData.cs ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```csharp
/// <summary>
/// Gets the <see cref="UserCollectionResult"/> that contains the items that match the selection criteria.
/// </summary>
/// <returns>The <see cref="UserCollectionResult"/>.</returns>
public Task<UserCollectionResult> GetAllAsync() => DataInvoker.Current.InvokeAsync(this, () => GetAllOnImplementationAsync());
```

ã“ã“ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ `GetAllOnImplementationAsync` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è‡ªå‰ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã“ã§ UserData.cs ã‚’ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ« ã‚¯ãƒ©ã‚¹ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ (Generated ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹ UserData.cs ã¯ç›´æ¥ä¿®æ­£ã—ãªã„ã§ãã ã•ã„)ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¦ `GraphServiceClient` ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã€`GetAllOnImplementationAsync` ã§ `GraphServiceClient` ã‚’ä½¿ã£ã¦å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```csharp
namespace Karamem0.MyApplication.Business.Data
{
    /// <summary>
    /// Provides the <see cref="User"/> data access.
    /// </summary>
    public partial class UserData : IUserData
    {
        private readonly GraphServiceClient _graphServiceClient;

        /// <summary>
        /// Initializes a new instance of the <see cref="UserData"/> class.
        /// </summary>
        public UserData(GraphServiceClient graphServiceClient) : this()
        {
            _graphServiceClient = graphServiceClient;
        }

        /// <summary>
        /// Gets the <see cref="UserCollectionResult"/> that contains the items that match the selection criteria.
        /// </summary>
        /// <returns>The <see cref="UserCollectionResult"/>.</returns>
        public async Task<UserCollectionResult> GetAllOnImplementationAsync()
        {
            var __result = await _graphServiceClient.Users.Request().GetAsync();
            return new UserCollectionResult(__result.Select(_ => new Entities.User()
            {
                Id = new Guid(_.Id),
                UserPrincipalName = _.UserPrincipalName,
                DisplayName = _.DisplayName,
            }));
        }
    }
}
```

## Api/Startup.cs

UserData.cs ã« DI ã§ `GraphServiceClient` ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã« `ConfigureServices` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ§‹æˆã—ã¾ã™ã€‚ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ã‚ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã« Client Credentials Grant ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒ **çµ¶å¯¾ã«çœŸä¼¼ã—ãªã„ã§ãã ã•ã„**ã€‚é€šå¸¸ã¯ `AddMicrosoftGraph` ãƒ¡ã‚½ãƒƒãƒ‰ã§æ§‹æˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```csharp
services.AddSingleton<GraphServiceClient>(services =>
{
    var credential = new ClientSecretCredential(
    _config.GetValue<string>("MicrosoftGraph:TenantId"),
    _config.GetValue<string>("MicrosoftGraph:ClientId"),
    _config.GetValue<string>("MicrosoftGraph:ClientSecret"));
    var scopes = new[] { "https://graph.microsoft.com/.default" };
    var client = new GraphServiceClient(credential);
    return client;
});
```

https://docs.microsoft.com/ja-jp/azure/active-directory/develop/scenario-web-api-call-api-app-configuration?WT.mc_id=M365-MVP-5002941

## Api/webapisettings.json

åˆ¥é€” Azure AD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¦ãã®æƒ…å ±ã‚’ webapisettings.json ã«è¨­å®šã—ã¾ã™ã€‚

```json
"MicrosoftGraph": {
  "TenantId": "{{tenent-id}}",
  "ClientId": "{{client-id}}",
  "ClientSecret": "{{tenent-secret}}"
},
```

# å®Ÿè¡Œçµæœ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ `http://localhost:5000/swagger` ã‚’èµ·å‹•ã— `/users` ã‚’å®Ÿè¡Œã—ã¦çµæœãŒå–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ãŸå ´åˆã§ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®ã¿ã‚’å®Ÿè£…ã™ã‚Œã°ã„ã„ã®ã§ã€ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚æ—¢å®šã®ãƒ‡ãƒ¼ã‚¿ ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã§ã‚‚ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„ã¨ãã¯åŒæ§˜ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€ãœã²è¦šãˆã¦ãŠããŸã„ã§ã™ã€‚
