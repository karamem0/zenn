---
title: "SharePoint Online ã® REST API ã‚’ PowerShell ã‹ã‚‰å©ã„ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["powershell", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2016/12/17 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

:::message alert
2017/8/24 è¿½è¨˜: OAuth ã®èªå¯ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦ã®ä¸é©åˆ‡ãªå†…å®¹ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚
:::

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ **PowerShell Advent Calendar 2016** ã®å‚åŠ è¨˜äº‹ã§ã™ã€‚

https://qiita.com/advent-calendar/2016/powershell

å‰å›ã®è¨˜äº‹ã§ã€ŒREST API ã‚’ Invoke-RestMethod ã§å©ã‘ã‚‹ã‹ã‚‚ã€ã¨ä¸¸æŠ•ã’ãªã“ã¨ã‚’æ›¸ã„ã¦ã—ã¾ã£ãŸã®ã§ã€å®Ÿéš›ã«ã‚„ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://zenn.dev/karamem0/articles/2016_12_10_000000

# OAuth ã«ã¤ã„ã¦ãŠã•ã‚‰ã„

SharePoint Online ã® REST API ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Azure AD ã® OAuth ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚Azure AD ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®èªå¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

- Authorization Code Grant
- Implicit Grant
- Client Credentials Grant
  - å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
  - è¨¼æ˜æ›¸
- Resource Owner Password Credentials Grant
- Device Flow

Authorization Code ã¨ Implicit Grant ã«ã¤ã„ã¦ã¯ UI (Web ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼) ã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‰æãªã®ã§ã€PowerShell ã®å ´åˆã¯ãã‚Œä»¥å¤–ã®æ–¹æ³•ã‚’é¸æŠã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã®ä»–ã®æ–¹æ³•ã‚’ç°¡å˜ã«æ¯”è¼ƒã™ã‚‹ã¨ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚

|èªå¯ãƒ•ãƒ­ãƒ¼|ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯|é›£æ˜“åº¦|ç„¡äººåŒ–|ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£|
|-|-|-|-|-|
|Client Credentials (å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ)|ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³|ä½|å¯|ä½|
|Client Credentials (è¨¼æ˜æ›¸)|ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³|é«˜|å¯|é«˜|
|Device Flow|ãƒ¦ãƒ¼ã‚¶ãƒ¼|ä¸­|ä¸å¯|-|

ã©ã¡ã‚‰ã‚‚ãƒ¡ãƒªãƒƒãƒˆã¨ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã®ã§ç›®çš„ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ã®ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚ä»Šå›ã¯ Device Flow ã«ã‚ˆã‚‹èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

# å®Ÿè¡Œæ–¹æ³•

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç™»éŒ²

Azure ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰ Azure AD ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©å½“ãªåå‰ã§ç™»éŒ²ã—ã¾ã™ã€‚

![](/images/2016_12_17_000000_001.png)

ä½¿ç”¨ã™ã‚‹ API ã« **Office 365 SharePoint Online** ã‚’é¸æŠã—ã¾ã™ã€‚

![](/images/2016_12_17_000000_002.png)

ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’é¸æŠã—ã¾ã™ã€‚ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ãƒ•ãƒ« ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ä»˜ã‘ã¦ã„ã¾ã™ãŒã€é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

![](/images/2016_12_17_000000_003.png)

ã“ã‚Œã§äº‹å‰æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

C# ã ã¨ `WebClient` ã‚„ `HttpClient` ã‚’ä½¿ã£ã¦é¢å€’ãªå‡¦ç†ã‚’æ›¸ãã“ã¨ã«ãªã‚Šã¾ã™ãŒã€PowerShell ã®å ´åˆã¯ `Invoke-RestMethod` ã‚’ä½¿ã£ã¦ã‹ãªã‚Šã™ã£ãã‚Šæ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```powershell
$tenantId = "{{tenant-id}}"
$resourceUri = "{{resource-uri}}"
$clientId = "{{client-id}}"

# ãƒ‡ãƒã‚¤ã‚¹ ã‚³ãƒ¼ãƒ‰ã®å–å¾—
$uri = "https://login.microsoftonline.com/" + $TenantId + "/oauth2/devicecode?" + `
       "resource=" + [System.Uri]::EscapeDataString($resourceUri) + "&" + `
       "client_id=" + $clientId
$headers = @{
    "Accept" = "application/json"
}
$result = Invoke-RestMethod -Method "Get" -Uri $uri -Headers $headers

$userCode = $result.user_code
$deviceCode = $result.device_code

Write-Output $userCode
Start-Process "https://aka.ms/devicelogin"

Read-Host | Out-Null

# ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
$uri = "https://login.microsoftonline.com/" + $TenantId + "/oauth2/token"
$headers = @{
    "Accept" = "application/json"
    "Content-Type" = "application/x-www-form-urlencoded"
}
$body = "resource=" + [System.Uri]::EscapeDataString($resourceUri) + "&" + `
        "client_id=" + $clientId + "&" + `
        "grant_type=device_code&" + `
        "code=" + [System.Uri]::EscapeDataString($deviceCode)

$result = Invoke-RestMethod -Method "Post" -Uri $uri -Headers $headers -Body $body

$accessToken = $result.access_token

# ã‚µã‚¤ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
$uri = $resourceUri + "/_api/web/title"
$headers = @{
    "Accept" = "application/json"
    "Authorization" = "Bearer " + $accessToken
}
$result = Invoke-RestMethod -Method "Get" -Uri $uri -Headers $headers
Write-Output $result.value

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§ã‚’å–å¾—
$uri = $resourceUri + "/_api/web/getfolderbyserverrelativeurl('/Shared%20Documents')/files"
$headers = @{
    "Accept" = "application/json"
    "Authorization" = "Bearer " + $accessToken
}
$result = Invoke-RestMethod -Method "Get" -Uri $uri -Headers $headers
$result.value | select Name, TimeCreated, TimeLastModified
```

# å®Ÿè¡Œçµæœ

å®Ÿè¡Œã™ã‚‹ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚èªè¨¼ãŒè¡Œã‚ã‚Œã‚‹ã¾ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å…¥åŠ›å¾…ã¡çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚åˆã‚ã›ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒèµ·å‹•ã™ã‚‹ã®ã§ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![](/images/2016_12_17_000000_004.png)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’ç¢ºèªã—ã¦ **ç¶šè¡Œ** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚çµ„ç¹”ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è¦æ±‚ã•ã‚Œã¾ã™ã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![](/images/2016_12_17_000000_005.png)

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã¨å®Œäº†ã«ãªã‚Šã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã¯é–‰ã˜ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

![](/images/2016_12_17_000000_006.png)

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ Enter ã‚­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†é–‹ã—ã¾ã™ã€‚SharePoint Online ã‹ã‚‰ã‚µã‚¤ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

SharePoint Online å˜ä½“ã ã¨ CSOM ã®ã»ã†ãŒä¾¿åˆ©ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä»–ã® Office 365 ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã™ã‚‹å ´åˆãªã©ã¯ã€REST API ã‚’ä½¿ã†ã¨çµ±ä¸€ã•ã‚ŒãŸæ–¹æ³•ã§æ›¸ãã“ã¨ãŒã§ããã†ã§ã™ã€‚

ã¡ãªã¿ã«ã€CSOM ãŒã©ã†ã‚„ã£ã¦ SharePoint Online ã«èªè¨¼ã‚’ã—ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€`BPOSIDCRL` ã¨ã„ã†æ–¹å¼ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚BPOS ã®åå‰ã®é€šã‚Šã€ãƒ¬ã‚¬ã‚·ãƒ¼ãªæ–¹æ³•ãªã®ã§ã€ã„ã¤ã¾ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ã€‚æ°—ã«ãªã‚Šã¾ã™ã€‚
