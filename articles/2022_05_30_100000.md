---
title: "React + TypeScript + Vite ã§ babel-plugin-react-intl-auto ã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["react", "typescript", "vite"]
published: true
---

# ã¯ã˜ã‚ã«

React ã§é–‹ç™ºã‚’ã™ã‚‹ã¨ãã«ã¯å…¬å¼ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ [Create React App](https://ja.reactjs.org/docs/create-a-new-react-app.html) ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„ã ã¨æ€ã„ã¾ã™ãŒã€Create React App ã¯ç°¡å˜ãªã‚†ãˆã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒé›£ã—ã„ã¨ã„ã†ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°

- Create React App ãŒ Jest ã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã§ããªã„
- Create React App ã®å†…éƒ¨ã®è¨­å®šã‚’æ›¸ãæ›ãˆã‚‰ã‚Œãªã„ (eject ã™ã‚‹ã‹ react-app-rewired ã‚„ craco ãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹)
- å˜ç´”ã«ãƒ“ãƒ«ãƒ‰ãŒé…ã„

ã¨ã„ã†ã‚ˆã†ãªã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã« Create React App ã§ã¯ãªã [Vite](https://vitejs.dev) ã«ç§»è¡Œã™ã‚‹æµã‚ŒãŒèµ·ãã¦ã„ã¾ã™ã€‚åˆç´šè€…ãŒä½¿ã†ã«ã¯ Create React App ã¯ä¾¿åˆ©ãªã®ã§å¿…ãšã—ã‚‚åŠ£ã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒã€ä¸­ç´šè€…ä»¥ä¸Šã«ãªã£ã¦ã‚ã‚‹ç¨‹åº¦ã„ã‚ã„ã‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„ã¨ã„ã†ã“ã¨ã«ãªã£ãŸã‚‰ Vite ã«ç§»è¡Œã™ã‚‹ã®ã‚‚è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

React ã§ i18n ã‚’ã™ã‚‹ã¨ãã« (ã‚ã‚‹ã„ã¯å˜ã«æ–‡å­—åˆ—ã‚’ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã—ãŸã„ã¨ãã«) [react-intl](https://www.npmjs.com/package/react-intl) ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€react-intl ã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã® [babel-plugin-react-intl-auto](https://www.npmjs.com/package/babel-plugin-react-intl-auto) ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯ä½œè€…ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚

https://qiita.com/akameco/items/ccf32dedb3630f774358

ã“ã‚Œã‚’ Vite ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/vite-with-babel-plugin-react-intl-auto

# å®Ÿè¡Œç’°å¢ƒæ§‹ç¯‰

ã¾ãšã¯ Vite ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚å¾Œè¿°ã—ã¾ã™ãŒ Storybook ãŒç¾æ™‚ç‚¹ã§ã¯ React 18 ã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ React 17 ã®æœ€æ–°ç‰ˆã§ã‚ã‚‹ vite@2.9.0 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
npm create vite@2.9.0 my-application -- --template react-ts
```

react-intl ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
npm install react-intl
```

babel-plugin-react-intl-auto ã‚’è¿½åŠ ã—ã¾ã™ã€‚åˆã‚ã›ã¦ extract-react-intl-messages ã‚‚å…¥ã‚Œã‚‹ã¨å¹¸ã›ã«ãªã‚Œã¾ã™ã€‚

```
npm install babel-plugin-react-intl-auto extract-react-intl-messages --save-dev
```

TypeScript ãŒ babel-plugin-react-intl-auto ã‚’èªè­˜ã§ãã‚‹ã‚ˆã†ã« `tsconfig.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
    "include": [
      "src",
+     "node_modules/babel-plugin-react-intl-auto/**/*.d.ts"
    ],
```

Vite ãŒ babel-plugin-react-intl-auto ã‚’èªè­˜ã§ãã‚‹ã‚ˆã†ã« `vite.config.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
  export default defineConfig({
    plugins: [
      react(
+     {
+       babel: {
+         plugins: [
+           'react-intl-auto'
+         ]
+       }
+     }
    )]
  })
```

extract-react-intl-messages ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã« `babel.config.js` ã‚’ä½œæˆã—ã¾ã™ã€‚

```javascript
module.exports = {
  plugins: [
    'react-intl-auto'
  ]
};
```

`src/messages.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import { defineMessages } from 'react-intl';

const messages = defineMessages({
  HelloWorld: 'ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ'
});

export default messages;
```

`src/translations/ja.json` ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```
npx extract-messages -l ja -o src/translations --flat src/messages.ts
```

`src/translations/ja.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```json
{
  "src.HelloWorld": "ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ"
}
```

`src/translations.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import ja from './translations/ja.json';

const translations: { [key: string]: Record<string, string> } = {
  ja
};

export default translations;
```

`src/App.tsx` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
- import { useState } from 'react'
+ import React, { useState } from 'react'
  import logo from './logo.svg'
  import './App.css'
+ import { FormattedMessage, IntlProvider } from 'react-intl'
+ import translations from './translations'
+ import messages from './messages'
  
  function App() {
    const [count, setCount] = useState(0)
  
    return (
      <div className="App">
        <header className="App-header">
          <img src={logo} className="App-logo" alt="logo" />
          <p>Hello Vite + React!</p>
          <p>
            <button type="button" onClick={() => setCount((count) => count + 1)}>
              count is: {count}
            </button>
          </p>
          <p>
            Edit <code>App.tsx</code> and save to test HMR updates.
          </p>
          <p>
            <a
              className="App-link"
              href="https://reactjs.org"
              target="_blank"
              rel="noopener noreferrer"
            >
              Learn React
            </a>
            {' | '}
            <a
              className="App-link"
              href="https://vitejs.dev/guide/features.html"
              target="_blank"
              rel="noopener noreferrer"
            >
              Vite Docs
            </a>
          </p>
+         <p>
+           <IntlProvider locale='ja' messages={translations.ja}>
+             <FormattedMessage {...messages.HelloWorld} />
+           </IntlProvider>
+         </p>
        </header>
      </div>
    )
  }
  
  export default App
```

`npm run dev` ã‚’å®Ÿè¡Œã— `http://localhost:3000` ã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ã€Œã“ã‚“ã«ã¡ã¯ä¸–ç•Œã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

# ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰

ãƒ†ã‚¹ãƒˆã¯ Jest ã¨ Storybook ã§è¡Œã„ã¾ã™ã€‚

## Jest

å…ˆè¿°ã—ãŸé€šã‚Šã€Create React App ã¨ç•°ãªã‚Š Vite ã«ã¯ Jest ãŒå«ã¾ã‚Œãªã„ã®ã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã“ã‚ã‹ã‚‰ã¯ã˜ã‚ã¾ã™ã€‚TypeScript ã§ Jest ã‚’ã™ã‚‹å ´åˆã¯ ts-jest ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€ts-jest ã§ã¯ Babel ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿ãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸãŸã‚ã€babel-jest ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã¾ãŸã€Babel ã®é–¢é€£ã™ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆã‚‚è¿½åŠ ã—ã¾ã™ã€‚

```
npm install jest jest-environment-jsdom @types/jest @testing-library/react@12 @testing-library/jest-dom --save-dev
npm install babel-jest @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript --save-dev
```

`jest.config.js` ã‚’ä½œæˆã—ã¾ã™ã€‚

```javascript
module.exports = {
  testEnvironment: 'jsdom',
  testMatch: [
    '**/*.test.ts',
    '**/*.test.tsx'
  ],
  moduleNameMapper: {
    "\\.(css|svg)$": '../jest.mock.js'
  }
};
```

`jest.mock.js` ã‚’ä½œæˆã—ã¾ã™ã€‚CSS ã¨ SVG ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã ã‘ãªã®ã§ä¸­èº«ã¯ç©ºã§ã™ã€‚

```
module.exports = {};
```

`babel.config.js` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚Jest ã®å…¬å¼ã‚µã‚¤ãƒˆã«ã‚‚èª¬æ˜ãŒã‚ã‚‹é€šã‚Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ node ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

https://jestjs.io/ja/docs/getting-started

```javascript
module.exports = {
  presets: [
    [
      "@babel/preset-env",
      {
        targets: {
          node: "current"
        }
      }
    ],
    "@babel/preset-react",
    "@babel/preset-typescript"
  ],
  plugins: [
    'react-intl-auto'
  ]
};
```

`src/App.test.tsx` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
import React from 'react';

import { render, screen } from '@testing-library/react';
import App from './App';

describe('App', () => {

  it('create shapshot', () => {
    render(<App />);
    expect(screen.queryAllByText(/^.*$/)[0]).toMatchSnapshot();
  });

});
```

`npx jest` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

## Storybook

Storybook ã«ã¯ Vite å‘ã‘ã®ãƒ“ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚Šç°¡å˜ã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
npx sb init --builder @storybook/builder-vite
```

Babel ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ `.storybook/main.js` ã« `viteFinal` ã‚’è¨­å®šã—ã¾ã™ã€‚

https://github.com/storybookjs/builder-vite/issues/286

```javascript
  viteFinal: (config) => {
    const react = require("@vitejs/plugin-react");
    config.plugins = [
      ...config.plugins.filter((plugin) => {
        return !(
          Array.isArray(plugin) && plugin[0].name === "vite:react-babel"
        );
      }),
      react({
        exclude: [/\.stories\.(t|j)sx?$/, /node_modules/],
        babel: {
          plugins: [
            'react-intl-auto'
          ]
        },
      }),
    ];
    return config;
  }
```

`src/App.stories.tsx` ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import React from 'react';
import { ComponentStory, ComponentMeta } from '@storybook/react';

import App from './App';

export default {
  title: 'App',
  component: App,
} as ComponentMeta<typeof App>;

const Template: ComponentStory<typeof App> = (args) => <App />;

export const Primary = Template.bind({});
Primary.args = {};
```

`npm run storybook` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Œã“ã‚“ã«ã¡ã¯ä¸–ç•Œã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

# ãŠã‚ã‚Šã«

Storybook ã«ã¤ã„ã¦ã¯ @storybook/builder-vite ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã§ã‚ã‚‹ Ian ã•ã‚“ã«æ•™ãˆã¦ã„ãŸã ãã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

https://twitter.com/IanVanSchooten/status/1529542219530911744
