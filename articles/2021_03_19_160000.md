---
title: "SharePoint Framework ã§ gulp test ã‚’ä½¿ã£ã¦è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["sharepoint", "typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2021/3/19 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

SharePoint Framework ã§ã‚‚è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ãŸã„ã¨ã„ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å¹¸ã„å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ Jest ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹æ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/sharepoint/dev/spfx/toolchain/implement-ci-cd-with-azure-devops?WT.mc_id=M365-MVP-5002941

ã“ã®æ–¹æ³•ã§ã¯ `package.json` ã‚’æ›¸ãæ›ãˆã¦æ—¢å®šã® `gulp test` ã§ã¯ãªã Jest ã‚’ç›´æ¥å‘¼ã³å‡ºã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã‚Œã¯ãã‚Œã§ã„ã„ã®ã§ã™ãŒæ—¢å®šã® `gulp test` ã®ã¾ã¾ã§å®Ÿæ–½ã§ããªã„ã®ã‹ãªã¨æ€ã£ãŸã®ã§ã¡ã‚‡ã£ã¨è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-framework-jest-task

# å®Ÿè¡Œæ–¹æ³•

ãã‚‚ãã‚‚ `gulp test` ãŒä½•ã‚’ã™ã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚SharePoint Framework ã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã§ã¯ `@microsoft/gulp-core-build` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/sharepoint/dev/spfx/toolchain/sharepoint-framework-toolchain?WT.mc_id=M365-MVP-5002941

ãã“ã§ `@microsoft/gulp-core-build` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’è¾¿ã£ã¦ã„ãã¨ `JestTask` ã¨ã„ã†ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚ã©ã†ã‚„ã‚‰ã“ã‚Œã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/microsoft/rushstack/blob/master/core-build/gulp-core-build/src/tasks/JestTask.ts

ä¸€èˆ¬çš„ã« Jest ã‚’ä½¿ã£ã¦ TypeScript ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ `ts-jest` ã‚’ä½¿ã£ã¦å†…éƒ¨çš„ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã®ã§ã™ãŒã€`gulp test` ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã®å ´åˆã€äº‹å‰ã® `gulp` ã‚¿ã‚¹ã‚¯ã§ `tsc` ã‚„ `webpack` ãŒå®Ÿè¡Œã•ã‚Œ `lib` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«æ ¼ç´ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¾ã™ã€‚

## å˜ç´”ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹

å…¨ä½“çš„ãªæµã‚Œã¯ã‚ã‹ã£ãŸã®ã§å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆ ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ `@types/jest` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚`@microsoft/gulp-core-build` ãŒä½¿ã£ã¦ã„ã‚‹ Jest ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ 23.6.0 ãªã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```
npm install @types/jest@23.3.14 --save-dev
```

`tsconfig.json` ã§ Jest ãŒå‹è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff
    "types": [
      "es6-promise",
      "webpack-env",
+     "jest"
    ],
```

`components` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã« `MyApplicattion.test.tsx` ã‚’ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦é©å½“ã«ãƒ†ã‚¹ãƒˆ ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

```typescript
// ã¨ã‚Šã‚ãˆãšå¿…ãš PASS ã™ã‚‹ãƒ†ã‚¹ãƒˆ
it('test1', () => {
  expect(true).toBe(true);
});
```

`gulp test` ã™ã‚Œã°ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¯ãšã§ã™ãŒã€è©¦ã—ã¦ã¿ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚`JestTask` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`isEnabled` ã¨ã„ã†è¨­å®šãŒã‚ã£ã¦ã“ã‚Œã‚’ `true` ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ `config/jest.json` ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã¾ãŸä»Šå›ã¯ `coverage` ã¯ä½¿ã‚ãªã„ã®ã§ `false` ã«ã—ã¦ãŠãã¾ã™ã€‚

```json
{
  "isEnabled": true,
  "coverage": false
}
```

ã“ã‚Œã§å†åº¦ `gulp test` ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
[00:00:00] Starting subtask 'jest'...
 PASS  lib\webparts\my-application\components\MyApplicattion.test.js
[00:00:00] Finished subtask 'jest' after 1.5
```

## ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹

åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã“ã¨ã¯ã‚ã‹ã‚Šã¾ã—ãŸãŒã€React ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ ãƒ†ã‚¹ãƒˆã‚‚å®Ÿæ–½ã—ã¦ã¿ãŸã„ã§ã™ã€‚ã¾ãšã¯ React ã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

https://jestjs.io/ja/docs/tutorial-react

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
npm install babel-jest@22.4.4 react-test-renderer@16.8.6 @types/react-test-renderer@16.8.3 babel-preset-env babel-preset-react --save-dev
```

`.babelrc` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  "presets": [
    "babel-preset-env",
    "babel-preset-react"
  ]
}
```

ãƒ†ã‚¹ãƒˆ ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
import * as React from 'react';
import { create } from 'react-test-renderer';
import MyApplication from './MyApplication';
import { IMyApplicationProps } from './IMyApplicationProps';

// ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ãƒ†ã‚¹ãƒˆ
it('test2', () => {
  const props = {} as IMyApplicationProps;
  const tree = create(<MyApplication {...props} />).toJSON();
  expect(tree).toMatchSnapshot();
});
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```
[00:00:00] Starting subtask 'jest'...
 FAIL  lib\webparts\my-application\components\MyApplicattion.test.js
  â— Test suite failed to run

    SyntaxError: Unexpected token .

       5 |     container: 'container_835912dc',
       6 |     row: 'row_835912dc',
    >  7 |     column: 'column_835912dc',
       8 |     'ms-Grid': 'ms-Grid_835912dc',
       9 |     title: 'title_835912dc',
      10 |     subTitle: 'subTitle_835912dc',

      at ScriptTransformer._transformAndBuildScript (node_modules/jest-cli/node_modules/jest-runtime/build/script_transformer.js:316:17)
      at Object.<anonymous> (lib/webparts/my-application/components/MyApplication.module.scss.js:7:1)
      at Object.<anonymous> (lib/webparts/my-application/components/MyApplication.js:11:28)
      at Object.<anonymous> (lib/webparts/my-application/components/MyApplicattion.test.js:9:22)

[00:00:00] Error - 'jest' sub task errored after 1.86 s
 Jest tests failed
[00:00:00] 'test' errored after 8.45 s
[00:00:00]
[00:00:00] ==================[ Finished ]==================
Error - 'jest' sub task errored after 1.86 s
 Jest tests failed
```

ã“ã‚Œã¯ CSS ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `require` ã—ã‚ˆã†ã¨ã—ã¦å¤±æ•—ã—ã¦ã„ã‚‹ã®ãŒåŸå› ãªã®ã§ã€ãƒ¢ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚

https://qiita.com/Amsel/items/8a4859d06a8de551abf8

`config/jest/jest.config.json` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  "moduleNameMapper": {
    "\\.css$": "<rootDir>/__mocks__/cssmock.js"
  }
}
```

`__mocks__/cssmock.js` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
module.exports = '';
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã™ã€‚

```
[00:00:00] Starting subtask 'jest'...
 PASS  lib\webparts\my-application\components\MyApplicattion.test.js
[00:00:00] Finished subtask 'jest' after 1.53 s
[00:00:00] Finished 'test' after 7.64 s
```

# ãŠã‚ã‚Šã«

ã‚„ã‚Œã°ã§ãã‚‹ã€‚ã‘ã©æ™®é€šã« Jest ä½¿ã£ãŸã»ã†ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚
