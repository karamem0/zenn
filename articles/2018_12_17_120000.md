---
title: "Binary Module (C#) ã§ã„ã„æ„Ÿã˜ã« Write-Verbose ã—ãŸã„"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "powershell"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2018/12/17 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

:::message alert
2018/12/20 è¿½è¨˜: [Twitter](https://twitter.com/aetos382/status/1075540598143148032) ã§ã”æŒ‡æ‘˜ã„ãŸã ãã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚[ã“ã¡ã‚‰ã®è¨˜äº‹](https://tech.blog.aerie.jp/entry/2016/02/15/172855) ã«ã‚ã‚‹ã‚ˆã†ã«ã€ç¢ºã‹ã«ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã¨ `EndProcessing` ãŒå‘¼ã°ã‚Œãªã„ã®ã§ã€`TraceListener` ãŒè§£é™¤ã•ã‚Œãšã«ãƒ¡ãƒ¢ãƒª ãƒªãƒ¼ã‚¯ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚`IDisposable` ã‚’å®Ÿè£…ã—ã¦ã‚ã’ã‚‹ã®ãŒã‚ˆã„ã‚ˆã†ã§ã™ã­ã€‚
:::

:::message alert
2019/04/19 è¿½è¨˜: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½¿ã£ãŸã¨ãã«é§„ç›®ã¿ãŸã„ã§ã™ã€‚è©³ç´°ã¯ [Stackoverflow](https://stackoverflow.com/questions/41157349/how-to-avoid-writeverbose-writeobject-bad-thread) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ **PowerShell Advent Calendar 2018** ã®å‚åŠ è¨˜äº‹ã§ã™ã€‚

https://qiita.com/advent-calendar/2018/powershell

ã¡ãªã¿ã«æŠ•ç¨¿ãŒé…ã‚ŒãŸã®ã§ã¯ãªã 16 æ—¥ãŒåŸ‹ã¾ã£ã¦ã„ãªã‹ã£ãŸã®ã§ç©´åŸ‹ã‚ã—ã¦ã„ã¾ã™ã€‚ã“ã“é‡è¦ï¼

# Write-Verbose ã«ã¤ã„ã¦

PowerShell ã§ã¯ `Verbose` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å‡ºåŠ›ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨ã§ã¯ `Write-Verbose` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§å‡ºåŠ›å†…å®¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚Script Module ã®å ´åˆã€PowerShell ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã‚’å‘¼ã³å‡ºã™ã ã‘ãªã®ã§ã€ç‰¹ã«ä½•ã‚‚è€ƒãˆã‚‹å¿…è¦ã¯ãªã„ã®ã§ã™ãŒã€Binary Module ã®å ´åˆã¯å‹æ‰‹ãŒé•ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€`Cmdlet.WriteVerbose` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `static` ã§ã¯ãªã„ã‹ã‚‰ã§ã™ã€‚å˜ç´”ãªã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã§ã‚ã‚Œã°ã€`ProcessRecord` ãƒ¡ã‚½ãƒƒãƒ‰ã§å…¨éƒ¨æ›¸ã‘ã°æ¸ˆã‚€ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚ã‚‹ç¨‹åº¦ã®è¦æ¨¡ã«ãªã£ã¦ãã‚‹ã¨ãã†ã‚‚ã„ãã¾ã›ã‚“ã€‚ã‹ã¨ã„ã£ã¦ `Cmdlet` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒã¡å›ã™ã®ã‚‚ç¾ã—ã„ã¨ã¯æ€ãˆã¾ã›ã‚“ã€‚

# Trace.WriteLine ãŒã‚ã‚‹ã˜ã‚ƒãªã„ã‹

C# ã«ã¯ `Trace.WriteLine` ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚ã“ã„ã¤ã‚’ä½¿ãˆã°ã„ã‘ã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã—ãŸãŒã€æ¨™æº–ã§ã¯ `Trace.WriteLine` ã‚’ãƒ›ã‚¹ãƒˆã«æµã—è¾¼ã‚“ã§ãã‚Œã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã«ã¯ãªã£ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚[^1] ä»•æ–¹ãŒãªã„ã®ã§ `TraceLister` ã‚’è‡ªä½œã—ã¾ã™ã€‚

## CmdletTraceListener.cs

```csharp
public class CmdletTraceListener : TraceListener
{
    private readonly Cmdlet cmdlet;

    public CmdletTraceListener(Cmdlet cmdlet)
    {
        if (cmdlet == null)
        {
            throw new ArgumentNullException(nameof(cmdlet));
        }
        this.cmdlet = cmdlet;
    }

    public override void Write(string message)
    {
        this.cmdlet.WriteVerbose(message);
    }

    public override void WriteLine(string message)
    {
        this.cmdlet.WriteVerbose(message);
    }
}
```

## TraceableCmdlet.cs

```csharp
public abstract class TraceableCmdlet : PSCmdlet
{
    private readonly TraceListener traceListener;

    protected TraceableCmdlet()
    {
        this.traceListener = new CmdletTraceListener(this);
    }

    protected override void BeginProcessing()
    {
        Trace.Listeners.Add(this.traceListener);
        base.BeginProcessing();
    }

    protected override void EndProcessing()
    {
        base.EndProcessing();
        Trace.Listeners.Remove(this.traceListener);
    }
}
```

ã“ã†ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€ã©ã“ã‹ã‚‰ã§ã‚‚ `Trace.WriteLine` ã‚’å‘¼ã³å‡ºã™ã ã‘ã§ (`Verbose` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã‚Œã°) ãƒ›ã‚¹ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã—ã€ç–çµåˆã«ãªã‚‹ã®ã§ãƒ†ã‚¹ãƒˆã‚‚å®¹æ˜“ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

[^1]: `Console.WriteLine` ã¯ `Write-Host` ã¨åŒæ§˜ã«å‹•ä½œã—ã¾ã™ã€‚
