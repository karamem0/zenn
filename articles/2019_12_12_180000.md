---
title: "PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ Azure Artifacts ã«å…¬é–‹ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["csharp", "powershell"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2019/12/12 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ **Azure DevOps Advent Calendar 2019** ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚

https://qiita.com/advent-calendar/2019/azuredevops

Azure DevOps ã«ã¯ Azure Artifacts ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚Azure Artifacts ã§ã¯ NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã®ã§ã€PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹ã—ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Azure Pipelines ã§PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ Azure Artifacts ã«å…¬é–‹ã™ã‚‹ã¾ã§ã®æ‰‹é †ã‚’è¦‹ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# å®Ÿè¡Œæ–¹æ³•

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™

ä»Šå›ä½œæˆã™ã‚‹ PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ PowerShell Core ã‚’å‰æã¨ã—ã¾ã™ã®ã§ã€.NET Core 2.1 ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ **HelloPowerShell** ã¨ã„ã†åå‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ ãƒ•ã‚¡ã‚¤ãƒ« (`.psd1`) ã¨ NuGet ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ ãƒ•ã‚¡ã‚¤ãƒ« (`.nuspec`) ã‚’ä½œæˆã—ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ Azure Repos ã® Git ã« push ã—ã¾ã™ã€‚

## Build Pipeline ã®ä½œæˆ

Build Pipeline ã‚’ä½œæˆã—ã¾ã™ã€‚**Azure Repos Git** ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã— **Starter pipeline** ã§æœ€å°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® YAML ã‚’ä½œæˆã—ã¾ã™ã€‚ä½œæˆã—ãŸ YAML ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```yaml
trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  solutionFile: 'HelloPowerShell.csproj'
  manifestFile: 'HelloPowerShell.psd1'
  nuspecFile: 'HelloPowerShell.nuspec'
  buildConfiguration: 'Release'
  buildVersion: '1.0.0'
  buildId: '$(Build.BuildId)'

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "##vso[task.setvariable variable=buildNumber]$env:buildVersion.$env:buildId"
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Update-ModuleManifest -Path $env:manifestFile -ModuleVersion $env:buildNumber
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $xml=[xml](Get-Content $env:nuspecFile)
      $xml.package.metadata.version=$env:buildNumber
      $xml.Save($env:nuspecFile)
- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '$(solutionFile)'
- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: '$(solutionFile)'
    arguments: '-c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory) -p:version=$(buildNumber);fileversion=$(buildNumber)'
    zipAfterPublish: false
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'HelloPowerShell'
    publishLocation: 'Container'
```

`dotnet publish` ã§ Artifact ã‚’ä½œæˆã™ã‚‹ã ã‘ã§ã™ãŒã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒ“ãƒ«ãƒ‰ã”ã¨ã«å¤‰ã‚ã‚‹ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æ›¸ãæ›ãˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

## Release Pipeline ã®ä½œæˆ

ç¶šã„ã¦ Release Pipeline ã‚’ä½œæˆã—ã¾ã™ã€‚Build Pipeline ã® Artifact ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«è¨­å®šã— CI/CD ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

![](/images/2019_12_12_180000_001.png)

ã‚¸ãƒ§ãƒ–ã§ã¯ NuGet ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€`nuget pack` ã¨ `nuget push` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](/images/2019_12_12_180000_002.png)

`nuget pack` ã§ã¯ã€å¯¾è±¡ã‚’ `.csproj` ã§ã¯ãªã `.nuspec` ã«å¤‰æ›´ã—ã¾ã™ã€‚

![](/images/2019_12_12_180000_003.png)

`nuget push` ã§ã¯ push ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ã« Azure Artifacts ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚

![](/images/2019_12_12_180000_004.png)

# å®Ÿè¡Œçµæœ

Pipeline ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Azure Artifacts ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/2019_12_12_180000_005.png)

ã‚ã¨ã¯ `Register-PSRepository` ã§ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€`Find-Module` ã‚„ `Install-Module` ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆãŒä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

https://docs.microsoft.com/en-us/azure/devops/artifacts/tutorials/private-powershell-library?WT.mc_id=PS-MVP-5002941
