---
title: "Office 365 ç®¡ç† API ã‚’ä½¿ã£ã¦ SharePoint Online ã®ç›£æŸ»ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["azuread", "csharp", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2020/9/2 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

ã„ã¾ã¾ã§ãšã£ã¨ SharePoint Online ã®ç›£æŸ»ãƒ­ã‚°ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ããªã„ã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒã€å®Ÿã¯ Office 365 ç®¡ç† API ã¨ã„ã†ã‚‚ã®ã‚’ä½¿ãˆã°å–å¾—ã§ãã‚‹ã®ã ãã†ã§ã™ã€‚Office 365 ç®¡ç† API ã¯ SharePointã€Exchangeã€Teamsã€Power Platform ãªã©ã®ã•ã¾ã–ã¾ãªç›£æŸ»ãƒ­ã‚°ã‚’å–å¾—ã§ãã‚‹ã®ã§ã™ãŒã€ç‰¹ã«åˆ©ç”¨çŠ¶æ³ã®ç›£è¦–ç›®çš„ã§ SharePoint Online ã®ç›£æŸ»ãƒ­ã‚°ã‚’å–ã‚ŠãŸã„ã¨ã„ã†è¦æœ›ã¯éå¸¸ã«å¤šã„ãŸã‚ã€ã“ã®æ–¹æ³•ã‚’ä½¿ãˆã°è§£æ±ºã§ãã‚‹ã®ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

ãªãŠä»Šå›ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

https://qiita.com/YoshiakiOi/items/16866f40c29618f05f39

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-office-365-management-api

# å®Ÿè¡Œæ–¹æ³•

Office 365 ç®¡ç† API ã§ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹ã«ã¯ä»¥ä¸‹ã®æ‰‹é †ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

- ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® URL ã‚’å–å¾—ã™ã‚‹
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã™ã‚‹

## ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹

Office 365 ç®¡ç† API ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã¯ã˜ã‚ã« Azure AD ã«ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯** ã§ã¯ **Office 365 Management APIs** - **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯** - **ActivityFeed.Read** ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![](/images/2020_09_02_150000_001.png)

ã¾ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚‚å–å¾—ã—ã¦ãŠãã¾ã™ã€‚

Office 365 ç®¡ç† API ã¯ Azure AD ã® v2.0 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ MSAL ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ADAL ã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€é¢å€’ãªã®ã§ã€ä»Šå›ã¯ç›´æ¥ `HttpClient` ã§å–ã‚Šã«è¡Œãã‚ˆã†ã«ã—ã¾ã™ã€‚ã¨ã„ã£ã¦ã‚‚ Client Credentials Grant ãªã®ã§ãã‚Œã»ã©é›£ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```csharp
private static void AcquireToken()
{
    var httpRequestUrl = $"https://login.microsoftonline.com/{TenantId}/oauth2/token";
    var httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, httpRequestUrl);
    var httpRequestContent = new FormUrlEncodedContent(new Dictionary<string, string>()
    {
        { "grant_type", "client_credentials" },
        { "resource", Resource },
        { "client_id", ClientId },
        { "client_secret", ClientSecret }
    });
    httpRequestMessage.Content = httpRequestContent;
    var httpResponseMessage = HttpClient.SendAsync(httpRequestMessage).GetAwaiter().GetResult();
    var httpResponseContent = httpResponseMessage.Content.ReadAsStringAsync().GetAwaiter().GetResult();
    var httpResponseJson = JsonConvert.DeserializeObject<JToken>(httpResponseContent);
    AccessToken = httpResponseJson.Value<string>("access_token");
}
```

## ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹

Office 365 ç®¡ç† API ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ã‚¿ã‚¤ãƒ— (`Audit.SharePoint`) ã«å¯¾ã—ã¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚Webhook ã‚‚ç™»éŒ²ã§ãã‚‹ã‚ˆã†ãªã®ã§ã™ãŒã€ä»Šå›ã¯çœç•¥ã—ã¾ã™ã€‚`PublisherIdentifier` ã¯ä»»æ„ã® GUID ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

```csharp
private static void CreateSubscription()
{
    var httpRequestUrl = $"https://manage.office.com/api/v1.0/{TenantId}/activity/feed/subscriptions/start" +
      $"?contentType=Audit.SharePoint" + 
      $"&PublisherIdentifier={PublisherIdentifier}";
    var httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, httpRequestUrl);
    httpRequestMessage.Headers.Authorization = new AuthenticationHeaderValue("Bearer", AccessToken);
    var httpResponseMessage = HttpClient.SendAsync(httpRequestMessage).GetAwaiter().GetResult();
    var httpResponseContent = httpResponseMessage.Content.ReadAsStringAsync().GetAwaiter().GetResult();
}
```

## ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® URL ã‚’å–å¾—ã™ã‚‹

ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹æ™‚é–“ã‚’æŒ‡å®šã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã® URL ã‚’å–å¾—ã—ã¾ã™ã€‚æ™‚é–“ã¯ 24 æ™‚é–“ä»¥å†…ã§éå» 7 æ—¥ä»¥å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯ 1 æ—¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚

```csharp
private static void GetContentUri()
{
    var startTime = DateTime.Today.AddDays(-1).ToUniversalTime().ToString("yyyy-MM-dd'T'HH:mm:ss");
    var endTime = DateTime.Today.AddSeconds(-1).ToUniversalTime().ToString("yyyy-MM-dd'T'HH:mm:ss");
    var httpRequestUrl = $"https://manage.office.com/api/v1.0/{TenantId}/activity/feed/subscriptions/content" +
        $"?contentType=Audit.SharePoint" +
        $"&PublisherIdentifier={PublisherIdentifier}" +
        $"&startTime={startTime}" +
        $"&endTime={endTime}";
    var httpRequestMessage = new HttpRequestMessage(HttpMethod.Get, httpRequestUrl);
    httpRequestMessage.Headers.Authorization = new AuthenticationHeaderValue("Bearer", AccessToken);
    var httpResponseMessage = HttpClient.SendAsync(httpRequestMessage).GetAwaiter().GetResult();
    var httpResponseContent = httpResponseMessage.Content.ReadAsStringAsync().GetAwaiter().GetResult();
    var httpResponseJson = JsonConvert.DeserializeObject<JArray>(httpResponseContent);
    ContentUri = httpResponseJson[0].Value<string>("contentUri");
}
```

## ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã™ã‚‹

å–å¾—ã—ãŸ URL ã‹ã‚‰ JSON å½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã—ã¾ã™ã€‚

```csharp
private static void GetContents()
{
    var httpRequestUrl = ContentUri;
    var httpRequestMessage = new HttpRequestMessage(HttpMethod.Get, httpRequestUrl);
    httpRequestMessage.Headers.Authorization = new AuthenticationHeaderValue("Bearer", AccessToken);
    var httpResponseMessage = HttpClient.SendAsync(httpRequestMessage).GetAwaiter().GetResult();
    var httpResponseContent = httpResponseMessage.Content.ReadAsStringAsync().GetAwaiter().GetResult();
    var httpResponseJson = JsonConvert.DeserializeObject<JArray>(httpResponseContent);
    Console.WriteLine(JsonConvert.SerializeObject(httpResponseJson, Formatting.Indented));
}
```

# å®Ÿè¡Œçµæœ

ä»¥ä¸‹ã®ã‚ˆã†ãª JSON ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ã™ãŒã€ãã‚Œã ã‘ã§ã¯ãªãã€ã„ã‚ã„ã‚ãªç¨®é¡ã®ãƒ­ã‚°ãŒå–å¾—ã§ãã¾ã™ã€‚

```json
[
  {
    "CreationTime": "2020-09-01T14:00:03",
    "Id": "bea6430c...",
    "Operation": "FileDownloaded",
    "OrganizationId": "92dbed3f...",
    "RecordType": 6,
    "UserKey": "i:0h.f|membership|{{user-principal-name}}",
    "UserType": 0,
    "Version": 1,
    "Workload": "OneDrive",
    "ClientIP": "203.0.113.1",
    "ObjectId": "https://{{tenant-name}}-my.sharepoint.com/personal/{{user-principal-name}}/Documents/fitbit.json",
    "UserId": "{{user-principal-name}}",
    "CorrelationId": "1aba0151...",
    "EventSource": "SharePoint",
    "ItemType": "File",
    "ListId": "ccf377fa...",
    "ListItemUniqueId": "3afd549b...",
    "Site": "0815189e...",
    "WebId": "15cdf073...",
    "HighPriorityMediaProcessing": false,
    "SourceFileExtension": "json",
    "SiteUrl": "https://{{tenant-name}}-my.sharepoint.com/personal/{{user-principal-name}}/",
    "SourceFileName": "fitbit.json",
    "SourceRelativeUrl": "Documents"
  },
...
]
```

ä½•ãŒå–å¾—ã§ãã‚‹ã‹ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance?WT.mc_id=M365-MVP-5002941

# ãŠã‚ã‚Šã«

Office 365 ç®¡ç† API ã«é–¢ã™ã‚‹æƒ…å ±ã¯ä»¥ä¸‹ã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

https://docs.microsoft.com/ja-jp/office/office-365-management-api?WT.mc_id=M365-MVP-5002941

ã‚ªãƒ³ãƒ—ãƒ¬ã® SharePoint ã§ç›£æŸ»ãƒ­ã‚°ã‚’å–ã£ã¦ã„ã‚ã„ã‚ã‚„ã£ã¦ã„ãŸã“ã¨ã‚’ã€SharePoint Online ã«ç§»è¡Œã—ã¦ã‚‚åŒã˜ã“ã¨ã‚’ã‚„ã‚ŠãŸã„ã€ã¨ã„ã†ã¨ãã«ãœã²ä½¿ã£ã¦ã„ãŸã ããŸã„ã¨æ€ã„ã¾ã™ã€‚
