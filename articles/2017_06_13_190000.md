---
title: "SharePoint Online ã® Excel Services (SOAP API) ã‚’å©ã„ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["azuread", "csharp", "sharepoint"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ã¯ã¦ãªãƒ–ãƒ­ã‚°ã« 2017/6/13 ã«æŠ•ç¨¿ã—ãŸã‚‚ã®ã®è»¢è¼‰ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

Excel Services ã‚’ä½¿ã†ã¨ SharePoint ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ Excel ã‚’ç·¨é›†ã¨ã„ã†ã¨ Open XML SDK ã‚’ä½¿ã†ã‹ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼è£½ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã†ã‹ã¨ã„ã†è©±ã«ãªã‚‹ã®ã§ã™ãŒã€Excel Services ã‚’ä½¿ãˆã°ã‚»ãƒ«ã®èª­ã¿æ›¸ãç¨‹åº¦ã§ã‚ã‚Œã°ç°¡å˜ã«ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚[^1] SOAP ãªã®ã§ Visual Studio ã‹ã‚‰ã¯ **ã‚µãƒ¼ãƒ“ã‚¹å‚ç…§ã®è¿½åŠ ** ã§ç°¡å˜ã«å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã— SharePoint Online ã®å ´åˆã¯ã“ã®æ–¹æ³•ã§ã¯å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚SharePoint Online ã¯ OAuth ãªã®ã§ã€å¯¾å¿œã—ã¦ã„ãªã„ã¨æ€ã‚ã‚Œã‚‹ WCF ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒé€šã‚Šã¾ã›ã‚“ã€‚ãªã®ã§ã€è‡ªåŠ›ã§ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰

https://github.com/karamem0/samples/tree/main/sharepoint-excel-service-using-oauth

Access Token ã®å–å¾—æ–¹æ³•ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®å†å–å¾—ã‚‚å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/karamem0/articles/2016_12_17_000000

WCF ã§ã‚«ã‚¹ã‚¿ãƒ  HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ Message Inspectors ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã„ã„ã‚ˆã†ã§ã™ã€‚

`IClientMessageInspector` ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å‰ã« Bearer Token ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```csharp
public class BearerClientMessageInspector : IClientMessageInspector
{

    public object BeforeSendRequest(ref Message request, IClientChannel channel)
    {
        var property = new HttpRequestMessageProperty();
        property.Headers.Add("Authorization", "Bearer {{access-token}}");
        request.Properties[HttpRequestMessageProperty.Name] = property;
        return null;
    }

}
```

`IEndpointBehavior` ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã€`ClientRuntime.ClientMessageInspectors` ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```csharp
public class BearerEndpointBehavior : IEndpointBehavior
{

    public void ApplyClientBehavior(ServiceEndpoint endpoint, ClientRuntime clientRuntime)
    {
        clientRuntime.ClientMessageInspectors.Add(new BearerClientMessageInspector());
    }

}
```

`SoapClient` ã® `EndpointBehaviors` ã«ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```csharp
using (var client = new ExcelServiceSoapClient())
{
    client.Endpoint.EndpointBehaviors.Add(new BearerEndpointBehavior());
    var status = default(Status[]);
    var sessionId = client.OpenWorkbook(FilePath, "", "", out status);
    var cell = client.GetCellA1(sessionId, "Sheet1", "A1", false, out status);
    client.CloseWorkbook(sessionId);
}
```

# ãŠã‚ã‚Šã«

Graph Excel REST API ä½¿ãˆã£ã¦ã“ã¨ã§ã™ã­ï¼

[^1]: ã¾ã•ã‹ã“ã®ã”æ™‚ä¸–ã« Excel COM ã§ã‚„ã‚ã†ã¨ã™ã‚‹äººã¯ã„ãªã„ã§ã™ã‚ˆã­ï¼Ÿ
